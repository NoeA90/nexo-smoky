<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEXO SMOKY • Gestor de Contactos Masivo</title>

  <!-- Font Awesome (CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #334155;
      --accent-primary: #3b82f6;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --accent-neutral: #6b7280;
      --accent-jugando: #8b5cf6;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #475569;
      --hover-color: #475569;
      --selection-bg: rgba(59, 130, 246, 0.2);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { background-color: var(--bg-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
    .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

    /* Upload */
    .upload-screen{
      position: fixed; inset: 0;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #1e1b4b 100%);
      display:flex; align-items:center; justify-content:center;
      z-index: 1000;
      transition: opacity .35s ease, transform .35s ease;
      padding: 20px;
    }
    .upload-screen.hidden{opacity:0; transform: scale(.98); pointer-events:none;}
    .upload-card{
      background: var(--bg-secondary); padding: 26px; border-radius: 18px;
      width: min(920px, 95vw);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      border: 1px solid rgba(59,130,246,.5);
    }
    .upload-header{
      display:flex; align-items:center; justify-content:space-between; gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .upload-title{
      display:flex; align-items:center; gap: 12px;
    }
    .upload-title i{ font-size: 2rem; color: var(--accent-primary); }
    .upload-title h1{
      font-size: 1.55rem; line-height: 1.1;
      background: linear-gradient(90deg, var(--accent-primary), #8b5cf6);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .upload-sub{ color: var(--text-secondary); font-size: .95rem; margin-top: 6px; }
    .upload-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 16px;
    }
    .panel{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 16px;
      min-height: 120px;
    }
    .panel h3{ font-size: .95rem; margin-bottom: 10px; color: var(--text-primary); }
    .panel p{ color: var(--text-secondary); font-size: .88rem; line-height: 1.35; }
    .file-upload-area{
      border: 2px dashed var(--border-color);
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      transition: all .25s;
      background: rgba(0,0,0,.12);
    }
    .file-upload-area:hover{ border-color: var(--accent-primary); background: rgba(59,130,246,.06); }
    .file-upload-area .row{
      display:flex; gap: 12px; align-items:flex-start;
    }
    .file-upload-area i{ font-size: 1.5rem; color: var(--accent-primary); margin-top: 2px; }
    .file-upload-area .meta{
      display:flex; flex-direction:column; gap: 4px;
    }
    .file-upload-area .meta strong{ font-size: .95rem; }
    .file-upload-area .meta span{ color: var(--text-secondary); font-size: .86rem; }

    .origin-input{
      width:100%; padding: 10px 12px; margin-top: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: .95rem;
    }
    .btn-primary{
      background: linear-gradient(90deg, var(--accent-primary), #6366f1);
      color: white; border: none; padding: 12px 18px; border-radius: 10px;
      font-size: 1rem; font-weight: 700; cursor: pointer;
      transition: all .25s; width: 100%;
      margin-top: 12px;
    }
    .btn-primary:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(59,130,246,.25); }
    .btn-primary:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .file-list{ margin-top: 10px; max-height: 120px; overflow:auto; display:flex; flex-direction:column; gap: 8px; }
    .file-item{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.06);
      padding: 9px 12px;
      border-radius: 10px;
      display:flex; justify-content:space-between; gap: 10px;
      font-size: .88rem;
    }
    .file-item .muted{ color: var(--text-secondary); }

    .switch-row{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .chip{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--text-secondary);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .82rem;
      display:flex; gap: 8px; align-items:center;
    }
    .chip input{ transform: translateY(1px); }

    .progress-mini{
      margin-top: 10px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 10px;
    }
    .progress-mini .top{
      display:flex; justify-content:space-between; gap: 10px;
      color: var(--text-secondary);
      font-size: .85rem;
      margin-bottom: 8px;
    }
    .progress-mini .bar{
      height: 10px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
    }
    .progress-mini .fill{
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--accent-primary), #8b5cf6);
      transition: width .2s ease;
    }

    /* Main UI */
    .navbar {
      background: var(--bg-secondary); padding: 15px 20px; border-radius: 15px; margin-bottom: 18px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .brand{
      display:flex; gap: 10px; align-items:center; flex-wrap: wrap;
    }
    .brand .logo{
      width: 38px; height: 38px; border-radius: 12px;
      background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 24px rgba(59,130,246,.25);
      font-weight: 900;
    }
    .brand .t{
      display:flex; flex-direction:column;
      line-height: 1.05;
    }
    .brand .t strong{ font-size: 1rem; }
    .brand .t span{ font-size: .82rem; color: var(--text-secondary); }

    .stats { display: flex; gap: 10px; flex-wrap: wrap; flex: 1; }
    .stat-box {
      background: var(--bg-card); padding: 10px 14px; border-radius: 12px; min-width: 122px;
      text-align: center; cursor: pointer; transition: all 0.25s; border: 2px solid transparent;
      user-select:none;
    }
    .stat-box:hover { transform: translateY(-2px); box-shadow: 0 7px 18px rgba(0, 0, 0, 0.25); }
    .stat-box.active { border-color: var(--accent-primary); }
    .stat-value { font-size: 1.25rem; font-weight: 800; }
    .stat-total .stat-value { color: var(--accent-primary); }
    .stat-unreviewed .stat-value { color: #9ca3af; }
    .stat-contactado .stat-value { color: var(--accent-success); }
    .stat-jugando .stat-value { color: var(--accent-jugando); }
    .stat-no-interesado .stat-value { color: var(--accent-danger); }
    .stat-sin-wsp .stat-value { color: var(--accent-neutral); }
    .stat-smoky .stat-value { color: #5cf6ff; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      padding: 10px 14px; border-radius: 10px; border: none; cursor: pointer; font-weight: 800;
      transition: all 0.25s; display: inline-flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,.06);
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,.09);
    }
    .btn-success { background: var(--accent-success); border-color: transparent; color: white; }
    .btn-danger { background: var(--accent-danger); border-color: transparent; color: white; }
    .btn-warning { background: var(--accent-warning); border-color: transparent; color: white; }
    .btn-primary2 { background: linear-gradient(90deg, var(--accent-primary), #6366f1); border-color: transparent; color: white; }
    .btn:hover { transform: translateY(-2px); opacity: 0.95; }

    .progress-container {
      background: var(--bg-secondary); padding: 14px 18px; border-radius: 15px; margin-bottom: 14px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      display:none;
    }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .progress-percentage { color: var(--accent-primary); font-weight: 800; }
    .progress-bar { height: 12px; background: var(--bg-card); border-radius: 999px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-primary), #8b5cf6); border-radius: 999px; transition: width 0.35s ease; }
    .progress-stats { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px; }

    .view-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; flex-wrap: wrap; gap: 12px; }
    .search-box { flex: 1; min-width: 280px; position: relative; }
    .search-input {
      width: 100%; padding: 12px 15px 12px 44px; background: var(--bg-card);
      border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 1rem;
    }
    .search-input:focus { outline: none; border-color: var(--accent-primary); }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
    .view-toggle { display: flex; gap: 5px; background: var(--bg-card); padding: 5px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); }
    .view-btn {
      padding: 10px 14px; background: transparent; border: none; color: var(--text-secondary);
      border-radius: 10px; cursor: pointer; transition: all 0.25s;
      display: flex; align-items: center; gap: 8px; font-weight: 800;
    }
    .view-btn.active { background: var(--accent-primary); color: white; }

    .cards-view, .list-view, .tinder-view { display: none; }
    .cards-view.active, .list-view.active, .tinder-view.active { display: grid; }
    .list-view.active { display: flex; flex-direction: column; gap: 10px; }
    .tinder-view.active { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh; }
    .cards-view { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 18px; }

    .contact-card, .list-item {
      background: var(--bg-card); border-radius: 15px; transition: all 0.25s; border-left: 5px solid;
      position: relative; box-shadow: 0 5px 14px rgba(0, 0, 0, 0.12);
    }
    .contact-card:hover, .list-item:hover { transform: translateY(-4px); box-shadow: 0 10px 22px rgba(0, 0, 0, 0.22); }
    .contact-card[data-status="jugando"], .list-item[data-status="jugando"] { border-left-color: var(--accent-jugando); }
    .contact-card[data-status="contactado"], .list-item[data-status="contactado"] { border-left-color: var(--accent-success); }
    .contact-card[data-status="no interesado"], .list-item[data-status="no interesado"] { border-left-color: var(--accent-danger); }
    .contact-card[data-status="sin wsp"], .list-item[data-status="sin wsp"] { border-left-color: var(--accent-neutral); }
    .contact-card[data-status="sin revisar"], .list-item[data-status="sin revisar"] { border-left-color: #9ca3af; }
    .contact-card.selected, .list-item.selected { background-color: var(--selection-bg); border-left-color: var(--accent-primary); }

    .contact-card { padding: 15px 18px; }
    .list-item { padding: 10px 18px; }

    .contact-name, .contact-phone {
      cursor: pointer; padding: 5px; border-radius: 8px; transition: background 0.2s;
      display: block; word-break: break-word; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .contact-name:hover, .contact-phone:hover { background: rgba(255, 255, 255, 0.1); }
    .inline-edit-input {
      background: var(--bg-secondary); border: 1px solid var(--accent-primary); color: var(--text-primary);
      border-radius: 8px; padding: 6px; font-size: inherit; width: 96%;
    }

    .contact-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 8px; }
    .contact-info { flex-grow: 1; flex-shrink: 1; min-width: 0; overflow: hidden; }
    .contact-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .origin-tag { font-size: 0.85rem; color: var(--text-secondary); text-align: right; word-break: break-all; white-space: normal; }

    .delete-contact-btn {
      background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem;
      padding: 6px; border-radius: 50%; width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .delete-contact-btn:hover { background: var(--accent-danger); color: white; }

    .whatsapp-btn {
      background: #25D366; color: white; padding: 8px 14px; border-radius: 10px; text-decoration: none;
      display: inline-flex; align-items: center; gap: 8px; width: fit-content; transition: all 0.25s; margin-top: 10px;
      font-weight: 900;
    }
    .whatsapp-btn:hover { background: #128C7E; transform: translateY(-2px); }

    .list-item-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .status-btn {
      background: rgba(0,0,0,.18); border: 1px solid var(--border-color); color: var(--text-secondary);
      border-radius: 10px; padding: 6px 10px; cursor: pointer; transition: all 0.2s; font-size: 0.82rem;
      display: inline-flex; align-items: center; gap: 6px; font-weight: 900;
    }
    .status-btn:hover { background: var(--hover-color); color: var(--text-primary); }

    .tinder-card {
      background: var(--bg-card); border-radius: 20px; padding: 34px; max-width: 520px; width: 95%;
      text-align: center; position: relative; transition: opacity 0.25s ease, transform 0.25s ease;
    }
    .tinder-card.fading { opacity: 0; transform: scale(0.985); }
    .tinder-name { font-size: 2rem; font-weight: 1000; }
    .tinder-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 18px; }
    .tinder-action-btn { padding: 12px; border-radius: 12px; border: none; color: white; cursor: pointer; transition: all 0.25s; font-weight: 1000; }
    .tinder-action-btn:hover { transform: translateY(-2px); opacity: 0.95; }
    .tinder-action-btn.siguiente { background: var(--accent-primary); grid-column: span 3; }
    .tinder-counter {
      position: absolute; top: 16px; right: 16px; background: var(--bg-secondary);
      padding: 8px 12px; border-radius: 999px; font-weight: 900;
      border: 1px solid rgba(255,255,255,.08);
    }

    .bulk-actions-bar {
      position: fixed; bottom: -120px; left: 50%; transform: translateX(-50%);
      background: var(--bg-secondary); padding: 14px 18px; border-radius: 15px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.35);
      display: flex; align-items: center; gap: 14px;
      transition: bottom 0.35s ease-in-out; z-index: 1500;
      border: 1px solid rgba(255,255,255,.09);
    }
    .bulk-actions-bar.active { bottom: 16px; }
    .bulk-actions-bar .status-select {
      min-width: 170px; padding: 8px 10px; border-radius: 10px; background: var(--bg-card);
      color: var(--text-primary); border: 1px solid var(--border-color);
      font-weight: 800;
    }

    .contact-selection { display: flex; align-items: center; gap: 12px; }
    .custom-checkbox {
      width: 20px; height: 20px; background: rgba(0,0,0,.2); border: 2px solid var(--border-color);
      border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center;
      transition: all 0.2s;
    }
    label.custom-checkbox { padding: 10px; margin: -10px; }
    .custom-checkbox i { color: white; font-size: 12px; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
    .contact-checkbox:checked + .custom-checkbox { background: var(--accent-primary); border-color: var(--accent-primary); }
    .contact-checkbox:checked + .custom-checkbox i { opacity: 1; transform: scale(1); }
    .contact-checkbox { display: none; }

    .modal {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.78); display: flex; justify-content: center; align-items: center;
      z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.25s;
      padding: 18px;
    }
    .modal.active { opacity: 1; pointer-events: all; }
    .modal-content {
      background: var(--bg-secondary); padding: 24px; border-radius: 18px; max-width: 560px; width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255,255,255,.08);
    }
    .modal h3 { margin-bottom: 14px; font-size: 1.25rem; color: var(--accent-primary); }
    .export-option, .duplicate-option {
      background: var(--bg-card); padding: 14px; border-radius: 12px; cursor: pointer;
      transition: all 0.25s; border: 2px solid transparent;
    }
    .export-option:hover, .duplicate-option:hover { border-color: var(--accent-primary); transform: translateY(-1px); }
    .export-option.selected, .duplicate-option.selected { border-color: var(--accent-primary); background: var(--selection-bg); }
    #exportFormatOptions { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }

    .notification {
      position: fixed; top: 18px; right: 18px; padding: 14px 18px; border-radius: 12px;
      color: white; font-weight: 900; z-index: 3000; transform: translateX(150%);
      transition: transform 0.45s cubic-bezier(0.68, -0.55, 0.265, 1.55); max-width: 420px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(16,185,129,.92);
    }
    .notification.show { transform: translateX(0); }
    .notification.info { background: rgba(59,130,246,.92); }
    .notification.warning { background: rgba(245,158,11,.92); }
    .notification.error { background: rgba(239,68,68,.92); }

    .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 22px; flex-wrap: wrap; }
    .page-btn { padding: 10px 12px; background: var(--bg-secondary); border: 1px solid rgba(255,255,255,.09); border-radius: 10px; color: var(--text-primary); cursor: pointer; transition: all 0.25s; font-weight: 900; }
    .page-btn:hover { background: var(--hover-color); }
    .page-btn.active { background: var(--accent-primary); color: white; border-color: transparent; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* nice scrollbar */
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,.18); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(59,130,246,.35); }

    @media (max-width: 900px) {
      .upload-grid{ grid-template-columns: 1fr; }
      .navbar, .view-controls { flex-direction: column; align-items: stretch; }
      .bulk-actions-bar { flex-direction: column; width: 92%; bottom: -220px; gap: 10px; padding: 14px; }
      .bulk-actions-bar.active { bottom: 10px; }
      .cards-view { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- UPLOAD / HOME -->
  <div class="upload-screen" id="uploadScreen">
    <div class="upload-card">
      <div class="upload-header">
        <div class="upload-title">
          <i class="fa-solid fa-link"></i>
          <div>
            <h1>NEXO SMOKY</h1>
            <div class="upload-sub">Unifica SMOKY (Activos vs No activos) + Gestor Masivo (revisión, estados, export y WhatsApp).</div>
          </div>
        </div>
        <div class="chip"><i class="fa-brands fa-chrome"></i> Optimizado para Chrome • Archivos grandes (33k+)</div>
      </div>

      <div class="upload-grid">
        <div class="panel">
          <h3><i class="fa-solid fa-bolt" style="color:var(--accent-primary)"></i> Paso 1: Importación “SMOKY” (recomendado)</h3>
          <p>
            Cargá: <b>Operaciones de agentes</b> (Fecha,Estado,Cantidad,Tipo,Alias,Balance) y <b>Contactos WTK</b>
            (number,name,email,tags,metadata). Te marca <b>JUGANDO</b> a los activos y <b>A CONTACTAR</b> al resto,
            y deja el teléfono listo en el Gestor.
          </p>

          <div style="margin-top:12px" class="file-upload-area" id="dropSmoky">
            <div class="row">
              <i class="fa-solid fa-cloud-arrow-up"></i>
              <div class="meta">
                <strong>Arrastrá 2 CSV (Ops + Contactos WTK)</strong>
                <span>o click para elegir archivos</span>
              </div>
            </div>
            <input type="file" id="smokyInput" accept=".csv" multiple style="display:none;">
          </div>

          <div class="file-list" id="smokyFileList"></div>

          <div class="switch-row">
            <div class="chip"><input type="checkbox" id="smokyPreferTitular"><label for="smokyPreferTitular">Si no matchea alias, probar “titular”</label></div>
            <div class="chip"><input type="checkbox" id="smokyDebug"><label for="smokyDebug">Debug en consola</label></div>
          </div>

          <button class="btn-primary" id="btnSmokyProcess"><i class="fa-solid fa-wand-magic-sparkles"></i> Procesar SMOKY → Abrir Gestor</button>

          <div class="progress-mini" id="smokyProgress" style="display:none;">
            <div class="top"><span id="smokyProgressText">Procesando…</span><span id="smokyProgressPct">0%</span></div>
            <div class="bar"><div class="fill" id="smokyProgressFill"></div></div>
          </div>
        </div>

        <div class="panel">
          <h3><i class="fa-solid fa-layer-group" style="color:var(--accent-primary)"></i> Paso 1 (alternativo): Importación Masiva (VCF/CSV)</h3>
          <p>
            Para cargar listas desde celular o CSV simples <code>name,number</code>. Ideal para sumar contactos adicionales.
            (Esto no calcula activos; solo carga datos al Gestor).
          </p>

          <div style="margin-top:12px" class="file-upload-area" id="dropArea">
            <div class="row">
              <i class="fa-solid fa-cloud-arrow-up"></i>
              <div class="meta">
                <strong>Arrastrá VCF/CSV</strong>
                <span>o click para elegir archivos</span>
              </div>
            </div>
            <input type="file" id="fileInput" multiple accept=".vcf,.vcard,.csv" style="display:none;">
          </div>

          <div class="file-list" id="fileList"></div>
          <input type="text" class="origin-input" id="originName" placeholder="Nombre del origen (ej: Celular Ventas)">
          <button class="btn-primary" id="processFiles"><i class="fa-solid fa-play"></i> Procesar y Comenzar</button>

          <div class="chip" style="margin-top:10px;">
            <i class="fa-solid fa-circle-info"></i>
            Tip: Si tu CSV viene de WTK (number,name,email,tags,metadata), también lo toma.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="container" id="mainInterface" style="display:none;">
    <div class="navbar">
      <div class="brand">
        <div class="logo">N</div>
        <div class="t">
          <strong>NEXO SMOKY</strong>
          <span>Contactos + Estados + Export • (SMOKY integrado)</span>
        </div>
      </div>

      <div class="stats">
        <div class="stat-box stat-total active" data-filter="all"><div class="stat-value" id="totalContacts">0</div><div>Total</div></div>
        <div class="stat-box stat-smoky" data-filter="smoky"><div class="stat-value" id="smokyActives">0</div><div>SMOKY Activos</div></div>
        <div class="stat-box stat-unreviewed" data-filter="sin revisar"><div class="stat-value" id="unreviewedContacts">0</div><div>Sin revisar</div></div>
        <div class="stat-box stat-contactado" data-filter="contactado"><div class="stat-value" id="contactedContacts">0</div><div>Contactado</div></div>
        <div class="stat-box stat-jugando" data-filter="jugando"><div class="stat-value" id="playingContacts">0</div><div>Jugando</div></div>
        <div class="stat-box stat-no-interesado" data-filter="no interesado"><div class="stat-value" id="notInterestedContacts">0</div><div>No interesado</div></div>
        <div class="stat-box stat-sin-wsp" data-filter="sin wsp"><div class="stat-value" id="noWhatsappContacts">0</div><div>Sin WSP</div></div>
      </div>

      <div class="controls">
        <button class="btn btn-primary2" id="smokyOpenBtn"><i class="fa-solid fa-bolt"></i> SMOKY (Ops+WTK)</button>
        <button class="btn btn-success" id="exportBtn"><i class="fa-solid fa-file-export"></i> Exportar</button>
        <button class="btn btn-danger" id="clearDataBtn"><i class="fa-solid fa-trash"></i> Borrar Todo</button>
        <button class="btn btn-warning" id="addMoreBtn"><i class="fa-solid fa-plus"></i> Agregar Más</button>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-header">
        <div class="progress-title">Progreso de revisión</div>
        <div class="progress-percentage" id="progressPercentage">0%</div>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="progress-stats"><span id="reviewedCount">0 revisados</span><span id="totalCount">0 totales</span></div>
    </div>

    <div class="view-controls">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Buscar por nombre, alias o número...">
      </div>
      <div style="display:flex; align-items:center; gap: 12px; flex-wrap: wrap;">
        <label for="selectAllCheckbox" class="custom-checkbox" style="display:none;"><i class="fas fa-check"></i></label>
        <input type="checkbox" id="selectAllCheckbox" class="contact-checkbox">
        <div class="view-toggle">
          <button class="view-btn active" data-view="cards"><i class="fas fa-th-large"></i> Tarjetas</button>
          <button class="view-btn" data-view="list"><i class="fas fa-list"></i> Lista</button>
          <button class="view-btn" data-view="tinder"><i class="fas fa-fire"></i> Revisión</button>
        </div>
      </div>
    </div>

    <div class="cards-view active" id="cardsView"></div>
    <div class="list-view" id="listView"></div>

    <div class="tinder-view" id="tinderView">
      <div class="tinder-card" id="tinderCard">
        <div class="tinder-counter" id="tinderCounter">1/0</div>
        <div class="tinder-header">
          <div class="tinder-name" id="tinderName">No hay contactos</div>
          <div id="tinderOrigin" style="color: var(--text-secondary); margin-top: 6px;"></div>
        </div>
        <div class="tinder-info" style="margin-top: 10px;">
          <div class="tinder-phone" id="tinderPhone">-</div>
          <a href="#" class="whatsapp-btn" id="tinderWhatsapp" target="_blank"><i class="fab fa-whatsapp"></i> Enviar WhatsApp</a>
        </div>
        <div class="tinder-actions">
          <button class="tinder-action-btn" id="tinderBack" style="background: var(--accent-neutral);"><i class="fas fa-undo"></i> Atrás</button>
          <button class="tinder-action-btn" data-status="sin wsp" style="background: var(--accent-neutral);"><i class="fas fa-ban"></i> Sin WSP</button>
          <button class="tinder-action-btn" data-status="no interesado" style="background: var(--accent-danger);"><i class="fas fa-times"></i> No Interesado</button>
          <button class="tinder-action-btn" data-status="jugando" style="background: var(--accent-jugando);"><i class="fas fa-gamepad"></i> Jugando</button>
          <button class="tinder-action-btn" data-status="contactado" style="background: var(--accent-success);"><i class="fas fa-check"></i> Contactado</button>
          <button class="tinder-action-btn" data-status="sin revisar" style="background: #9ca3af;"><i class="fas fa-clock"></i> Sin Revisar</button>
          <button class="tinder-action-btn siguiente" id="tinderNext"><i class="fas fa-arrow-right"></i> Siguiente</button>
        </div>
      </div>
    </div>

    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Modals -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <h3>Exportar Contactos</h3>
      <div style="display:flex; flex-direction:column; gap: 12px; margin: 14px 0;">
        <div class="export-option selected" data-type="filtered"><strong id="exportFilteredCount"></strong><p style="color:var(--text-secondary); margin-top:6px">Exportar la vista actual</p></div>
        <div class="export-option" data-type="all"><strong id="exportAllCount"></strong><p style="color:var(--text-secondary); margin-top:6px">Exportar todos los contactos</p></div>
      </div>

      <div style="margin-bottom: 18px;">
        <h4 style="font-size:1rem; margin-bottom:10px;">Formato:</h4>
        <div id="exportFormatOptions">
          <div class="export-option selected" data-format="excel"><i class="fas fa-file-excel"></i> CSV Completo</div>
          <div class="export-option" data-format="whaticket"><i class="fas fa-table"></i> CSV Whaticket (2 col)</div>
          <div class="export-option" data-format="vcf"><i class="fas fa-address-card"></i> VCF</div>
          <div class="export-option" data-format="sheet"><i class="fas fa-grip-horizontal"></i> Formato Planilla</div>
        </div>
        <div style="margin-top:10px; color: var(--text-secondary); font-size:.85rem; line-height:1.3">
          * En “Formato Planilla”, los <b>ACTIVOS</b> salen como <b>JUGANDO</b> y los demás como <b>A CONTACTAR</b>.
        </div>
      </div>

      <div style="display:flex; gap: 10px; margin-top: 16px;">
        <button class="btn" id="cancelExport" style="flex: 1;">Cancelar</button>
        <button class="btn btn-success" id="confirmExport" style="flex: 2;"><i class="fas fa-download"></i> Exportar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addMoreModal">
    <div class="modal-content">
      <h3>Agregar Más Contactos</h3>
      <div class="file-upload-area" id="dropAreaModal">
        <div class="row">
          <i class="fa-solid fa-cloud-arrow-up"></i>
          <div class="meta">
            <strong>Arrastra y suelta archivos</strong>
            <span>o haz clic para seleccionar</span>
          </div>
        </div>
        <input type="file" id="fileInputModal" multiple accept=".vcf,.vcard,.csv" style="display:none;">
      </div>
      <div class="file-list" id="fileListModal"></div>
      <input type="text" class="origin-input" id="originNameModal" placeholder="Nombre del origen (ej: Planilla Nueva)">
      <div style="display:flex; gap: 10px; margin-top: 16px;">
        <button class="btn" id="cancelAddMore" style="flex: 1;">Cancelar</button>
        <button class="btn btn-primary2" id="processFilesModal" style="flex: 2;"><i class="fas fa-play"></i> Procesar</button>
      </div>
      <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;">
        Tip: Para archivos enormes (33k+), preferí la carga SMOKY (usa Worker + streaming).
      </p>
    </div>
  </div>

  <div class="modal" id="duplicateModal">
    <div class="modal-content">
      <h3><i class="fas fa-exclamation-triangle" style="color: var(--accent-warning);"></i> Se encontraron duplicados</h3>
      <p style="color: var(--text-secondary); margin: 12px 0;">
        Se han encontrado <strong id="duplicateCount">0</strong> contactos que ya existen en tu lista. ¿Qué deseas hacer?
      </p>
      <div style="display:flex; flex-direction:column; gap: 12px; margin: 14px 0;">
        <div class="duplicate-option selected" data-action="skip"><strong>Omitir Duplicados</strong><p style="color:var(--text-secondary); margin-top:6px">No importar los contactos que ya existen.</p></div>
        <div class="duplicate-option" data-action="overwrite"><strong>Sobrescribir</strong><p style="color:var(--text-secondary); margin-top:6px">Actualizar los contactos existentes con la nueva información.</p></div>
        <div class="duplicate-option" data-action="keep"><strong>Mantener Ambos</strong><p style="color:var(--text-secondary); margin-top:6px">Importar los duplicados como contactos nuevos.</p></div>
      </div>
      <button class="btn btn-primary2" id="confirmDuplicateAction" style="width:100%;">Continuar</button>
    </div>
  </div>

  <div class="bulk-actions-bar" id="bulkActionsBar">
    <strong id="bulkSelectedCount">0 seleccionados</strong>
    <select class="status-select" id="bulkStatusSelect"></select>
    <button class="btn btn-danger" id="bulkDeleteBtn"><i class="fas fa-trash"></i> Eliminar</button>
    <button class="btn" id="bulkCancelBtn"><i class="fas fa-times"></i></button>
  </div>

  <div class="notification" id="notification"></div>

<script>
(() => {
  'use strict';

  /* ==========================================================
     WHY THIS VERSION DOESN'T "CUELGA" (33k+):
     - CSV parsing pesado se hace en Web Worker (no bloquea UI)
     - CSV se lee por CHUNKS (streaming) => no explota memoria
     - Render siempre paginado (50 por página) y Tinder/Lista
     - Guardado: localStorage SOLO si dataset < 15k (evita lag)
     ========================================================== */

  const AppState = {
    contacts: [],
    filteredContacts: [],
    filesToProcess: [],
    currentView: 'cards',
    currentPage: 1,
    itemsPerPage: 50,
    currentFilter: 'all',
    tinderIndex: 0,
    selectedContacts: new Set(),
    smokyActiveSet: new Set(), // alias activos detectados por ops
  };

  const STATUS_OPTIONS = [
    { id: 'sin revisar', label: 'Sin Revisar', icon: 'fas fa-clock' },
    { id: 'jugando', label: 'Jugando', icon: 'fas fa-gamepad' },
    { id: 'contactado', label: 'Contactado', icon: 'fas fa-check' },
    { id: 'no interesado', label: 'No Interesado', icon: 'fas fa-times' },
    { id: 'sin wsp', label: 'Sin WSP', icon: 'fas fa-ban' }
  ];

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  const elements = {
    uploadScreen: $('#uploadScreen'),
    mainInterface: $('#mainInterface'),

    // Masivo import
    fileInput: $('#fileInput'),
    dropArea: $('#dropArea'),
    fileList: $('#fileList'),
    originName: $('#originName'),
    processFiles: $('#processFiles'),

    // Smoky import
    dropSmoky: $('#dropSmoky'),
    smokyInput: $('#smokyInput'),
    smokyFileList: $('#smokyFileList'),
    btnSmokyProcess: $('#btnSmokyProcess'),
    smokyPreferTitular: $('#smokyPreferTitular'),
    smokyDebug: $('#smokyDebug'),
    smokyProgress: $('#smokyProgress'),
    smokyProgressText: $('#smokyProgressText'),
    smokyProgressPct: $('#smokyProgressPct'),
    smokyProgressFill: $('#smokyProgressFill'),
    smokyOpenBtn: $('#smokyOpenBtn'),

    // Main
    cardsView: $('#cardsView'),
    listView: $('#listView'),
    tinderView: $('#tinderView'),
    tinderCard: $('#tinderCard'),
    searchInput: $('#searchInput'),
    pagination: $('#pagination'),
    notification: $('#notification'),

    progressContainer: $('#progressContainer'),
    progressFill: $('#progressFill'),
    progressPercentage: $('#progressPercentage'),
    reviewedCount: $('#reviewedCount'),
    totalCount: $('#totalCount'),

    bulkActionsBar: $('#bulkActionsBar'),
    bulkSelectedCount: $('#bulkSelectedCount'),
    bulkStatusSelect: $('#bulkStatusSelect'),
    selectAllCheckbox: $('#selectAllCheckbox'),
    selectAllLabel: $('label[for="selectAllCheckbox"]'),

    addMoreModal: $('#addMoreModal'),
    fileInputModal: $('#fileInputModal'),
    fileListModal: $('#fileListModal'),
    dropAreaModal: $('#dropAreaModal'),
    originNameModal: $('#originNameModal'),
    processFilesModal: $('#processFilesModal'),

    exportModal: $('#exportModal'),
    exportBtn: $('#exportBtn'),
    cancelExport: $('#cancelExport'),
    confirmExport: $('#confirmExport'),
    exportFilteredCount: $('#exportFilteredCount'),
    exportAllCount: $('#exportAllCount'),

    addMoreBtn: $('#addMoreBtn'),
    cancelAddMore: $('#cancelAddMore'),
    clearDataBtn: $('#clearDataBtn'),
  };

  function showNotification(message, type = 'info') {
    elements.notification.textContent = message;
    elements.notification.className = `notification ${type} show`;
    setTimeout(() => elements.notification.classList.remove('show'), 3200);
  }

  /* -----------------------------
     Normalización (tel + alias)
  ----------------------------- */
  function cleanAliasBase(s) {
    if (!s) return '';
    return String(s)
      .toLowerCase()
      .trim()
      .replace(/\uFEFF/g,'')
      .replace(/\s+/g,' ')
      .replace(/["']/g,'')
      .replace(/^[^a-z0-9]+|[^a-z0-9]+$/g,'');
  }

  function normalizePhone(raw) {
    const s = String(raw || '').trim();
    if (!s) return { digits: '', e164: '' };
    let digits = s.replace(/\D/g, '');
    if (!digits) return { digits: '', e164: '' };

    // internacional 00
    if (s.startsWith('00')) {
      const intl = '+' + digits.slice(2);
      return { digits: intl.replace(/\D/g,''), e164: intl };
    }

    let e164 = '';
    if (digits.startsWith('54')) e164 = '+' + digits;
    else {
      if (digits.startsWith('0') && digits.length >= 10) digits = digits.slice(1);
      digits = digits.replace(/^(\d{2,4})15/, '$1');
      e164 = '+54' + digits;
    }
    return { digits: e164.replace(/\D/g,''), e164 };
  }

  // Contacts.name: "0011mar//Nombre Apellido" => alias "0011mar"
  function getAliasFromContactName(name) {
    const raw = cleanAliasBase(name);
    if (!raw) return '';
    if (raw.includes('//')) return cleanAliasBase(raw.split('//')[0]);
    return raw;
  }
  function getTitularFromContactName(name) {
    const s = String(name||'');
    if (!s.includes('//')) return '';
    return cleanAliasBase(s.split('//').slice(1).join('//'));
  }

  /* -----------------------------
     Light CSV parser (for small CSV)
     For huge CSV we use Worker streaming.
  ----------------------------- */
  function detectDelimiter(text) {
    const lines = String(text||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l => l.trim() !== '');
    if (/^sep=;/i.test(lines[0]||'')) return ';';
    if (/^sep=,/i.test(lines[0]||'')) return ',';
    const head = lines.slice(0, 6).join('\n');
    const commas = (head.match(/,/g) || []).length;
    const semis = (head.match(/;/g) || []).length;
    return semis > commas ? ';' : ',';
  }
  function parseCSVLine(line, delim) {
    const out = [];
    let cur = '';
    let inQuotes = false;
    for (let i=0; i<line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }
      if (!inQuotes && ch === delim) { out.push(cur); cur=''; continue; }
      cur += ch;
    }
    out.push(cur);
    return out.map(v => (v ?? '').trim());
  }

  function findHeaderIndex(headersLower, candidates) {
    for (let i=0;i<headersLower.length;i++){
      const h = headersLower[i];
      if (candidates.some(c => h === c || h.includes(c))) return i;
    }
    return -1;
  }

  /* -----------------------------
     Storage (evitamos lag con 33k)
  ----------------------------- */
  function canPersistLarge() {
    return AppState.contacts.length <= 15000; // 33k + localStorage = freeze
  }
  function loadData() {
    const saved = localStorage.getItem('nexoSmokyData_v1');
    if (!saved) return;
    try {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed?.contacts)) {
        AppState.contacts = parsed.contacts;
        AppState.smokyActiveSet = new Set(parsed.smokyActive || []);
        if (AppState.contacts.length > 0) openMain();
      }
    } catch (e) {
      console.warn('No se pudo cargar cache, reiniciando', e);
      localStorage.removeItem('nexoSmokyData_v1');
    }
  }
  function saveData() {
    if (!canPersistLarge()) return; // evita colgar
    const payload = {
      contacts: AppState.contacts,
      smokyActive: Array.from(AppState.smokyActiveSet).slice(0, 500000)
    };
    localStorage.setItem('nexoSmokyData_v1', JSON.stringify(payload));
  }

  function openMain() {
    elements.uploadScreen.classList.add('hidden');
    setTimeout(() => {
      elements.uploadScreen.style.display = 'none';
      elements.mainInterface.style.display = 'block';
      render();
    }, 350);
  }

  /* -----------------------------
     Render
  ----------------------------- */
  function debounce(fn, wait=140) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
  }

  function filterContacts() {
    const term = (elements.searchInput.value || '').toLowerCase().trim();
    let result;
    if (AppState.currentFilter === 'all') {
      result = [...AppState.contacts];
    } else if (AppState.currentFilter === 'smoky') {
      result = AppState.contacts.filter(c => c._smokyActive === true);
    } else {
      result = AppState.contacts.filter(c => c.status === AppState.currentFilter);
    }

    if (term) {
      result = result.filter(c =>
        (c.name || '').toLowerCase().includes(term) ||
        (c.alias || '').toLowerCase().includes(term) ||
        (c.phoneE164 || '').toLowerCase().includes(term) ||
        (c.phone || '').toLowerCase().includes(term)
      );
    }

    AppState.filteredContacts = result;
    const totalPages = Math.max(1, Math.ceil(result.length / AppState.itemsPerPage));
    if (AppState.currentPage > totalPages) AppState.currentPage = 1;
  }

  function updateStats() {
    $('#totalContacts').textContent = AppState.contacts.length.toLocaleString('es-AR');
    $('#smokyActives').textContent = AppState.contacts.filter(c => c._smokyActive).length.toLocaleString('es-AR');
    $('#unreviewedContacts').textContent = AppState.contacts.filter(c => c.status === 'sin revisar').length.toLocaleString('es-AR');
    $('#contactedContacts').textContent = AppState.contacts.filter(c => c.status === 'contactado').length.toLocaleString('es-AR');
    $('#playingContacts').textContent = AppState.contacts.filter(c => c.status === 'jugando').length.toLocaleString('es-AR');
    $('#notInterestedContacts').textContent = AppState.contacts.filter(c => c.status === 'no interesado').length.toLocaleString('es-AR');
    $('#noWhatsappContacts').textContent = AppState.contacts.filter(c => c.status === 'sin wsp').length.toLocaleString('es-AR');
  }

  function updateProgress() {
    const total = AppState.contacts.length;
    if (!total) { elements.progressContainer.style.display = 'none'; return; }
    elements.progressContainer.style.display = 'block';
    const reviewed = total - AppState.contacts.filter(c => c.status === 'sin revisar').length;
    const pct = Math.round((reviewed / total) * 100);
    elements.progressFill.style.width = `${pct}%`;
    elements.progressPercentage.textContent = `${pct}%`;
    elements.reviewedCount.textContent = `${reviewed.toLocaleString('es-AR')} revisados`;
    elements.totalCount.textContent = `${total.toLocaleString('es-AR')} totales`;
  }

  function createStatusButtons(contact) {
    let html = '<div class="list-item-actions">';
    for (const opt of STATUS_OPTIONS) {
      const isActive = contact.status === opt.id;
      const activeStyle = isActive ? 'style="background: rgba(59,130,246,.25); border-color: rgba(59,130,246,.55); color: white;"' : '';
      html += `<button class="status-btn" data-status="${opt.id}" ${activeStyle}><i class="${opt.icon}"></i> ${opt.label}</button>`;
    }
    html += '</div>';
    return html;
  }

  function createContactDOM(contact, type) {
    const el = document.createElement('div');
    el.className = type === 'card' ? 'contact-card' : 'list-item';
    el.dataset.id = contact.id;
    el.dataset.status = contact.status;
    if (AppState.selectedContacts.has(contact.id)) el.classList.add('selected');

    const displayPhone = contact.phoneE164 || contact.phone || 'Sin número';
    const waPhone = (contact.phone || '').replace(/\D/g,'');

    const smokyBadge = contact._smokyActive
      ? `<span class="origin-tag" style="color:#5cf6ff; font-weight:900; margin-right:6px">SMOKY</span>`
      : '';

    el.innerHTML = `
      <div style="display:flex; gap: 14px; align-items:flex-start; width:100%;">
        <div class="contact-selection">
          <input type="checkbox" id="check-${contact.id}" class="contact-checkbox" ${AppState.selectedContacts.has(contact.id) ? 'checked' : ''}>
          <label for="check-${contact.id}" class="custom-checkbox"><i class="fas fa-check"></i></label>
        </div>

        <div style="flex:1; min-width:0;">
          <div class="contact-header">
            <div class="contact-info">
              <span class="contact-name" data-field="name" title="Click para copiar / Doble click para editar">${contact.name || 'Sin nombre'}</span>
              <span class="contact-phone" data-field="phone" title="Click para copiar / Doble click para editar">${displayPhone}</span>
              ${contact.alias ? `<div style="margin-top:6px; color: var(--text-secondary); font-size:.85rem;">Alias: <b>${contact.alias}</b></div>` : ''}
            </div>
            <div class="contact-actions">
              ${smokyBadge}
              <span class="origin-tag">${contact.origin || ''}</span>
              <button class="delete-contact-btn" title="Eliminar Contacto"><i class="fas fa-trash"></i></button>
            </div>
          </div>

          ${waPhone ? `<a href="https://wa.me/${waPhone}" target="_blank" class="whatsapp-btn" onclick="event.stopPropagation();"><i class="fab fa-whatsapp"></i> WhatsApp</a>` : ''}

          ${type === 'list' ? createStatusButtons(contact) : ''}
        </div>
      </div>
    `;
    return el;
  }

  function createCard(c) { return createContactDOM(c, 'card'); }
  function createListItem(c) { return createContactDOM(c, 'list'); }

  function renderPagination() {
    const totalPages = Math.ceil(AppState.filteredContacts.length / AppState.itemsPerPage) || 1;
    if (AppState.currentView === 'tinder' || totalPages <= 1) { elements.pagination.innerHTML = ''; return; }

    elements.pagination.innerHTML = `
      <button class="page-btn" ${AppState.currentPage === 1 ? 'disabled' : ''} data-page="${AppState.currentPage - 1}">
        <i class="fas fa-chevron-left"></i>
      </button>
      <span style="color:var(--text-secondary); font-weight:900;">Página ${AppState.currentPage} de ${totalPages}</span>
      <button class="page-btn" ${AppState.currentPage === totalPages ? 'disabled' : ''} data-page="${AppState.currentPage + 1}">
        <i class="fas fa-chevron-right"></i>
      </button>
    `;
  }

  function renderPaginatedView(createFn) {
    const viewEl = $(`#${AppState.currentView}View`);
    viewEl.innerHTML = '';
    const start = (AppState.currentPage - 1) * AppState.itemsPerPage;
    const pageContacts = AppState.filteredContacts.slice(start, start + AppState.itemsPerPage);
    for (const c of pageContacts) viewEl.appendChild(createFn(c));
    renderPagination();
  }

  function renderTinderView() {
    const card = elements.tinderCard;
    card.classList.add('fading');

    setTimeout(() => {
      if (AppState.filteredContacts.length === 0) {
        $('#tinderName').textContent = 'No hay contactos';
        $('#tinderOrigin').textContent = '';
        $('#tinderPhone').textContent = '-';
        $('#tinderWhatsapp').href = '#';
        $('#tinderCounter').textContent = '0/0';
        card.classList.remove('fading');
        return;
      }

      if (AppState.tinderIndex >= AppState.filteredContacts.length) AppState.tinderIndex = 0;

      const contact = AppState.filteredContacts[AppState.tinderIndex];
      const waPhone = (contact.phone || '').replace(/\D/g,'');
      const displayPhone = contact.phoneE164 || contact.phone || 'Sin número';

      $('#tinderName').textContent = contact.name || 'Sin nombre';
      $('#tinderOrigin').textContent = `${contact.origin || ''}${contact.alias ? ' • ' + contact.alias : ''}`;
      $('#tinderPhone').textContent = displayPhone;
      $('#tinderWhatsapp').href = waPhone ? `https://wa.me/${waPhone}` : '#';
      $('#tinderCounter').textContent = `${AppState.tinderIndex + 1}/${AppState.filteredContacts.length}`;
      card.classList.remove('fading');
    }, 220);
  }

  function updateBulkActionsBar() {
    const count = AppState.selectedContacts.size;
    elements.bulkActionsBar.classList.toggle('active', count > 0);
    elements.bulkSelectedCount.textContent = `${count} seleccionados`;

    const pageContacts = AppState.filteredContacts.slice((AppState.currentPage - 1) * AppState.itemsPerPage, AppState.currentPage * AppState.itemsPerPage);
    const allOnPageSelected = pageContacts.length > 0 && pageContacts.every(c => AppState.selectedContacts.has(c.id));
    elements.selectAllCheckbox.checked = allOnPageSelected;
  }

  function updateView() {
    $$('.cards-view, .list-view, .tinder-view').forEach(v => v.classList.remove('active'));
    elements.selectAllLabel.style.display = ['cards','list'].includes(AppState.currentView) ? 'flex' : 'none';
    $(`.${AppState.currentView}-view`).classList.add('active');

    if (AppState.currentView === 'cards') renderPaginatedView(createCard);
    if (AppState.currentView === 'list') renderPaginatedView(createListItem);
    if (AppState.currentView === 'tinder') renderTinderView();

    elements.pagination.style.display = AppState.currentView === 'tinder' ? 'none' : 'flex';
  }

  function render() {
    filterContacts();
    updateStats();
    updateProgress();
    updateView();
    updateBulkActionsBar();
  }

  /* -----------------------------
     Update contact
  ----------------------------- */
  function updateContact(id, field, value) {
    const c = AppState.contacts.find(x => x.id === id);
    if (!c) return;

    if (field === 'phone') {
      const norm = normalizePhone(value);
      c.phone = norm.digits || '';
      c.phoneE164 = norm.e164 || '';
    } else if (field === 'name') {
      c.name = value;
      // refresca alias si corresponde
      c.alias = getAliasFromContactName(c.name);
    } else {
      c[field] = value;
    }

    c.lastUpdated = new Date().toISOString();
    saveData();
    render();
  }

  /* -----------------------------
     Export
  ----------------------------- */
  function csvEscape(v) {
    const s = String(v ?? '');
    if (s.includes('"') || s.includes(',') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"';
    return '"' + s + '"';
  }

  function downloadFile(content, fileName, mimeType) {
    const bom = mimeType.includes('csv') ? '\uFEFF' : '';
    const blob = new Blob([bom + content], { type: mimeType });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function exportToExcel(contacts) {
    let csv = "Nombre,Alias,Teléfono,Teléfono_E164,Origen,Estado,SMOKY_Activo,Fecha Actualización\n";
    for (const c of contacts) {
      csv += [
        csvEscape(c.name || ''),
        csvEscape(c.alias || ''),
        csvEscape(c.phone || ''),
        csvEscape(c.phoneE164 || ''),
        csvEscape(c.origin || ''),
        csvEscape(c.status || ''),
        csvEscape(c._smokyActive ? 'SI' : 'NO'),
        csvEscape(new Date(c.lastUpdated || Date.now()).toLocaleString('es-AR'))
      ].join(',') + '\n';
    }
    downloadFile(csv, `contactos_completo_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
    showNotification('Exportación CSV completa completada', 'success');
  }

  function exportToWhaticket(contacts) {
    let csv = "name,number\n";
    for (const c of contacts) {
      const name = (c.name || '').trim() || (c.alias || '').trim() || (c.phoneE164 || c.phone || '');
      const number = (c.phoneE164 || '').trim() || (normalizePhone(c.phone || '').e164 || '');
      if (!number) continue;
      csv += `${csvEscape(name)},${csvEscape(number)}\n`;
    }
    downloadFile(csv, `contactos_whaticket_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
    showNotification('Exportación CSV Whaticket completada', 'success');
  }

  function exportToVCF(contacts) {
    let vcf = '';
    for (const c of contacts) {
      const displayName = (c.name || '').trim() || (c.alias || '').trim() || 'Sin nombre';
      const tel = (c.phoneE164 || '').trim() || (normalizePhone(c.phone || '').e164 || '');
      vcf += `BEGIN:VCARD\nVERSION:3.0\nFN:${displayName}\n`;
      if (tel) vcf += `TEL;TYPE=CELL:${tel}\n`;
      vcf += `NOTE:Origen: ${c.origin || ''} | Estado: ${c.status || ''}\nEND:VCARD\n\n`;
    }
    downloadFile(vcf, `contactos_${new Date().toISOString().slice(0,10)}.vcf`, 'text/vcard;charset=utf-8');
    showNotification('Exportación VCF completada', 'success');
  }

  // Planilla estilo inicial (SMOKY integrado)
  function exportToSheetFormat(contacts) {
    const headers = `usuarios,estado de revision,,estado actual,"VISTO, RESPONDIDO?",RECUPERADO,TURNO DE LAS CARGAS,interesado en jugar?,ya contactados,recuperados!,actualmente cargando,TURNO MAÑANA,TURNO TARDE,TURNO NOCHE,contactos a borrar\n`;

    const estadoRevision = (c) => {
      // pedido: activos (SMOKY) => JUGANDO; el resto => A CONTACTAR
      if (c._smokyActive) return 'JUGANDO';
      return 'A CONTACTAR';
    };

    // columnas auxiliares (misma lógica del export viejo)
    const yaContactados = contacts.filter(c => c.status === 'contactado').map(c => c.name || c.alias || '');
    const recuperados = contacts.filter(c => c.status === 'jugando').map(c => c.name || c.alias || '');
    const actualmenteCargando = contacts.filter(c => c._smokyActive).map(c => c.name || c.alias || '');
    const turnoManana = [];
    const turnoTarde = [];
    const turnoNoche = [];
    const aBorrar = contacts.filter(c => c.status === 'no interesado').map(c => c.name || c.alias || '');

    const maxLength = Math.max(
      contacts.length, yaContactados.length, recuperados.length, actualmenteCargando.length,
      turnoManana.length, turnoTarde.length, turnoNoche.length, aBorrar.length
    );

    let csv = headers;
    for (let i=0;i<maxLength;i++){
      const c = contacts[i];
      const usuario = c ? (c.alias || c.name || '') : '';
      const est = c ? estadoRevision(c) : '';
      csv += [
        c ? csvEscape(usuario) : '',
        c ? csvEscape(est) : '',
        '',
        c ? csvEscape(est) : '',
        csvEscape('NO'),
        csvEscape('NO'),
        '',
        csvEscape('NO'),
        csvEscape(yaContactados[i] || ''),
        csvEscape(recuperados[i] || ''),
        csvEscape(actualmenteCargando[i] || ''),
        csvEscape(turnoManana[i] || ''),
        csvEscape(turnoTarde[i] || ''),
        csvEscape(turnoNoche[i] || ''),
        csvEscape(aBorrar[i] || '')
      ].join(',') + '\n';
    }

    downloadFile(csv, `planilla_exportada_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
    showNotification('Exportación a Formato Planilla completada', 'success');
  }

  /* -----------------------------
     Worker (SMOKY) - streaming parser
  ----------------------------- */
  const workerSrc = `
  let state = {
    mode: null,
    ops: { delim: ',', headers: null, hdrLower: null, idxAlias: -1, idxFecha: -1, idxMonto: -1, agg: new Map(), active: new Set(), rows: 0 },
    contacts: { delim: ',', headers: null, hdrLower: null, idxNumber: -1, idxName: -1, idxTags: -1, idxEmail: -1, idxMeta: -1, rows: 0, out: [] },
    preferTitular: false,
    leftovers: ''
  };

  function detectDelimiter(text) {
    const lines = String(text||'').replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n').split('\\n').filter(l => l.trim() !== '');
    if (/^sep=;/i.test(lines[0]||'')) return ';';
    if (/^sep=,/i.test(lines[0]||'')) return ',';
    const head = lines.slice(0, 6).join('\\n');
    const commas = (head.match(/,/g) || []).length;
    const semis = (head.match(/;/g) || []).length;
    return semis > commas ? ';' : ',';
  }
  function parseCSVLine(line, delim) {
    const out = [];
    let cur = '';
    let inQuotes = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }
      if (!inQuotes && ch === delim) { out.push(cur); cur=''; continue; }
      cur += ch;
    }
    out.push(cur);
    return out.map(v => (v ?? '').trim());
  }
  function cleanAliasBase(s) {
    if (!s) return '';
    return String(s).toLowerCase().trim()
      .replace(/\\uFEFF/g,'')
      .replace(/\\s+/g,' ')
      .replace(/[\\\\"']/g,'')
      .replace(/^[^a-z0-9]+|[^a-z0-9]+$/g,'');
  }
  function getAliasFromContactName(name) {
    const raw = cleanAliasBase(name);
    if (!raw) return '';
    if (raw.includes('//')) return cleanAliasBase(raw.split('//')[0]);
    return raw;
  }
  function getTitularFromContactName(name) {
    const s = String(name||'');
    if (!s.includes('//')) return '';
    return cleanAliasBase(s.split('//').slice(1).join('//'));
  }
  function findHeaderIndex(headersLower, candidates) {
    for (let i=0;i<headersLower.length;i++){
      const h = headersLower[i];
      if (candidates.some(c => h === c || h.includes(c))) return i;
    }
    return -1;
  }
  function parseNumberLoose(v) {
    let s = String(v ?? '').trim();
    if (!s) return 0;
    s = s.replace(/\\s+/g,'');
    s = s.replace(/[^0-9\\-,.]/g,'');
    if (s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');
    if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function setupOpsHeaders(headers) {
    state.ops.headers = headers;
    state.ops.hdrLower = headers.map(h => String(h||'').toLowerCase().trim());
    state.ops.idxFecha = findHeaderIndex(state.ops.hdrLower, ['fecha','date','datetime']);
    state.ops.idxMonto = findHeaderIndex(state.ops.hdrLower, ['cantidad','monto','importe','amount','balance']);
    state.ops.idxAlias = findHeaderIndex(state.ops.hdrLower, ['alias','usuario','user','jugador','player','cliente','titular']);
    // defaults para "Fecha,Estado,Cantidad,Tipo,Alias,Balance"
    if (state.ops.idxFecha === -1) state.ops.idxFecha = 0;
    if (state.ops.idxMonto === -1) state.ops.idxMonto = 2;
    if (state.ops.idxAlias === -1) state.ops.idxAlias = 4;
  }
  function setupContactsHeaders(headers) {
    state.contacts.headers = headers;
    state.contacts.hdrLower = headers.map(h => String(h||'').toLowerCase().trim());
    state.contacts.idxNumber = findHeaderIndex(state.contacts.hdrLower, ['number','telefono','tel','phone']);
    state.contacts.idxName   = findHeaderIndex(state.contacts.hdrLower, ['name','nombre']);
    state.contacts.idxEmail  = findHeaderIndex(state.contacts.hdrLower, ['email']);
    state.contacts.idxTags   = findHeaderIndex(state.contacts.hdrLower, ['tags']);
    state.contacts.idxMeta   = findHeaderIndex(state.contacts.hdrLower, ['metadata']);
    // fallback por orden: number,name,email,tags,metadata
    if (state.contacts.idxNumber === -1) state.contacts.idxNumber = 0;
    if (state.contacts.idxName === -1) state.contacts.idxName = 1;
    if (state.contacts.idxEmail === -1) state.contacts.idxEmail = 2;
    if (state.contacts.idxTags === -1) state.contacts.idxTags = 3;
    if (state.contacts.idxMeta === -1) state.contacts.idxMeta = 4;
  }

  function consumeLines(text, delim, onRow) {
    const s = (state.leftovers + String(text||'')).replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n');
    const lines = s.split('\\n');
    state.leftovers = lines.pop() || '';
    for (const line of lines) {
      if (!line || !line.trim()) continue;
      if (/^sep=/i.test(line.trim())) continue;
      onRow(line);
    }
  }

  function processOpsChunk(chunkText, isFirstChunk=false) {
    if (!state.ops.delim) state.ops.delim = detectDelimiter(chunkText);
    consumeLines(chunkText, state.ops.delim, (line) => {
      if (!state.ops.headers) {
        const hdr = parseCSVLine(line, state.ops.delim);
        setupOpsHeaders(hdr);
        return;
      }
      const cols = parseCSVLine(line, state.ops.delim);
      const aliasRaw = cols[state.ops.idxAlias] ?? '';
      const alias = cleanAliasBase(aliasRaw);
      if (!alias) return;
      const monto = parseNumberLoose(cols[state.ops.idxMonto] ?? '');
      state.ops.rows++;

      const it = state.ops.agg.get(alias) || { count:0, totalMonto:0 };
      it.count++;
      it.totalMonto += monto;
      state.ops.agg.set(alias, it);
      state.ops.active.add(alias);
    });
  }

  function processContactsChunk(chunkText) {
    if (!state.contacts.delim) state.contacts.delim = detectDelimiter(chunkText);
    consumeLines(chunkText, state.contacts.delim, (line) => {
      if (!state.contacts.headers) {
        const hdr = parseCSVLine(line, state.contacts.delim);
        setupContactsHeaders(hdr);
        return;
      }
      const cols = parseCSVLine(line, state.contacts.delim);
      const number = String(cols[state.contacts.idxNumber] ?? '').trim();
      const name = String(cols[state.contacts.idxName] ?? '').trim();
      if (!name && !number) return;

      const alias = getAliasFromContactName(name);
      const titular = getTitularFromContactName(name);

      // status SMOKY by matching alias OR titular (optional)
      let key = alias;
      let active = key && state.ops.active.has(key);
      let used = 'alias';
      if (!active && state.preferTitular && titular) {
        key = titular;
        active = state.ops.active.has(key);
        used = 'titular';
      }

      state.contacts.rows++;
      state.contacts.out.push({
        number, name,
        email: String(cols[state.contacts.idxEmail] ?? '').trim(),
        tags: String(cols[state.contacts.idxTags] ?? '').trim(),
        metadata: String(cols[state.contacts.idxMeta] ?? '').trim(),
        alias, titular,
        _smokyKeyUsed: used,
        _smokyActive: !!active,
        _opsCount: active ? (state.ops.agg.get(key)?.count || 0) : 0,
        _opsMonto: active ? (state.ops.agg.get(key)?.totalMonto || 0) : 0
      });

      if (state.contacts.out.length % 5000 === 0) {
        postMessage({ type:'progress', phase:'contacts', rows: state.contacts.rows });
      }
    });
  }

  onmessage = async (e) => {
    const msg = e.data || {};
    if (msg.type === 'init') {
      state = {
        mode: null,
        ops: { delim: ',', headers: null, hdrLower: null, idxAlias: -1, idxFecha: -1, idxMonto: -1, agg: new Map(), active: new Set(), rows: 0 },
        contacts: { delim: ',', headers: null, hdrLower: null, idxNumber: -1, idxName: -1, idxTags: -1, idxEmail: -1, idxMeta: -1, rows: 0, out: [] },
        preferTitular: !!msg.preferTitular,
        leftovers: ''
      };
      postMessage({ type:'ready' });
      return;
    }

    if (msg.type === 'chunk' && msg.mode === 'ops') {
      state.mode = 'ops';
      processOpsChunk(msg.text || '', !!msg.first);
      if (msg.done) {
        // flush leftovers
        if (state.leftovers && state.leftovers.trim()) processOpsChunk(state.leftovers, false);
        state.leftovers = '';
        postMessage({ type:'phaseDone', phase:'ops', rows: state.ops.rows, active: state.ops.active.size, delim: state.ops.delim, headers: state.ops.headers || [] });
      }
      return;
    }

    if (msg.type === 'chunk' && msg.mode === 'contacts') {
      state.mode = 'contacts';
      processContactsChunk(msg.text || '');
      if (msg.done) {
        if (state.leftovers && state.leftovers.trim()) processContactsChunk(state.leftovers);
        state.leftovers = '';
        postMessage({
          type:'done',
          ops: { rows: state.ops.rows, active: state.ops.active.size, delim: state.ops.delim, headers: state.ops.headers || [] },
          contacts: { rows: state.contacts.rows, delim: state.contacts.delim, headers: state.contacts.headers || [] },
          merged: state.contacts.out
        });
      }
      return;
    }
  };
  `;

  const worker = new Worker(URL.createObjectURL(new Blob([workerSrc], { type: 'text/javascript' })));

  function setSmokyProgress(on, text='', pct=0) {
    elements.smokyProgress.style.display = on ? 'block' : 'none';
    elements.smokyProgressText.textContent = text || 'Procesando…';
    elements.smokyProgressPct.textContent = `${pct}%`;
    elements.smokyProgressFill.style.width = `${pct}%`;
  }

  async function streamFileToWorker(file, mode, progressCb) {
    // lee por chunks
    const chunkSize = 1024 * 512; // 512KB
    const total = file.size || 1;
    let offset = 0;
    let first = true;

    while (offset < total) {
      const slice = file.slice(offset, offset + chunkSize);
      const text = await slice.text(); // browser API
      const done = offset + chunkSize >= total;

      worker.postMessage({ type:'chunk', mode, text, first, done });
      first = false;

      offset += chunkSize;
      if (progressCb) progressCb(Math.min(99, Math.floor((offset / total) * 100)));
      // deja respirar al main thread
      await new Promise(r => setTimeout(r, 0));
    }
  }

  function buildContactsFromWorkerMerged(mergedRows, origin='SMOKY') {
    // de worker vienen contactos con number/name/tags y flags
    const out = [];
    const seen = new Set(); // dedupe por tel (digits) o alias

    for (const r of mergedRows) {
      const norm = normalizePhone(r.number);
      const key = norm.digits ? `p_${norm.digits}` : `a_${r.alias || r.name || ''}`;
      if (seen.has(key)) continue;
      seen.add(key);

      const name = r.name || r.alias || 'Sin nombre';
      const alias = r.alias || getAliasFromContactName(name);

      out.push({
        id: `id_${Date.now()}_${Math.random().toString(36).slice(2,10)}`,
        name,
        alias,
        phone: norm.digits || '',
        phoneE164: norm.e164 || '',
        origin,
        status: r._smokyActive ? 'jugando' : 'sin revisar',
        lastUpdated: new Date().toISOString(),
        tags: r.tags || '',
        metadata: r.metadata || '',
        email: r.email || '',
        _smokyActive: !!r._smokyActive,
        _smokyKeyUsed: r._smokyKeyUsed || 'alias',
        _opsCount: r._opsCount || 0,
        _opsMonto: r._opsMonto || 0
      });
    }
    return out;
  }

  function mergeIntoAppContacts(newContacts, overwrite=false) {
    // dedupe por teléfono primero, si no por alias
    const byPhone = new Map();
    const byAlias = new Map();
    for (const c of AppState.contacts) {
      const kP = (c.phone || '').replace(/\D/g,'');
      if (kP) byPhone.set(kP, c);
      const kA = cleanAliasBase(c.alias || getAliasFromContactName(c.name || ''));
      if (kA) byAlias.set(kA, c);
    }

    let added=0, updated=0;
    for (const n of newContacts) {
      const kP = (n.phone || '').replace(/\D/g,'');
      const kA = cleanAliasBase(n.alias || getAliasFromContactName(n.name || ''));
      const existing = (kP && byPhone.get(kP)) || (kA && byAlias.get(kA)) || null;

      if (existing) {
        if (overwrite) {
          Object.assign(existing, n, { id: existing.id, lastUpdated: new Date().toISOString() });
          updated++;
        } else {
          // update soft: completar campos vacíos + smoky flags
          if ((!existing.phone || !existing.phoneE164) && (n.phone || n.phoneE164)) {
            existing.phone = n.phone || existing.phone;
            existing.phoneE164 = n.phoneE164 || existing.phoneE164;
          }
          if ((!existing.alias) && n.alias) existing.alias = n.alias;
          if ((!existing.name || existing.name.toLowerCase() === 'sin nombre') && n.name) existing.name = n.name;
          // smoky status: si es activo, lo marcamos jugando
          if (n._smokyActive) {
            existing._smokyActive = true;
            existing.status = 'jugando';
          }
          existing.lastUpdated = new Date().toISOString();
          updated++;
        }
      } else {
        AppState.contacts.push(n);
        if (kP) byPhone.set(kP, n);
        if (kA) byAlias.set(kA, n);
        added++;
      }
    }
    return { added, updated };
  }

  /* -----------------------------
     Masivo import (VCF / CSV)
  ----------------------------- */
  function addFilesToList(files) {
    AppState.filesToProcess.push(...files);
    renderFileList();
  }

  function renderFileList() {
    const listHTML = AppState.filesToProcess.map(file => `
      <div class="file-item">
        <span>${file.name}</span>
        <span class="muted">(${(file.size / 1024).toFixed(1)} KB)</span>
      </div>
    `).join('');
    elements.fileList.innerHTML = listHTML;
    elements.fileListModal.innerHTML = listHTML;
  }

  function parseVCF(text, origin) {
    const contacts = [];
    const vcards = String(text||'').split(/END:VCARD/i).filter(v => v.trim());

    for (let vcard of vcards) {
      const lines = vcard.split(/\r\n|\r|\n/).map(l => l.trim()).filter(Boolean);
      let name = 'Sin nombre';
      let phone = '';

      const fnLine = lines.find(l => l.toUpperCase().startsWith('FN:') || l.toUpperCase().startsWith('FN;'));
      const nLine = lines.find(l => l.toUpperCase().startsWith('N:') || l.toUpperCase().startsWith('N;'));
      const telLine = lines.find(l => l.toUpperCase().startsWith('TEL'));

      if (fnLine) name = fnLine.substring(fnLine.indexOf(':') + 1).trim() || 'Sin nombre';
      else if (nLine) {
        const raw = nLine.substring(nLine.indexOf(':') + 1);
        const parts = raw.split(';').map(p => p.trim()).filter(Boolean);
        name = [parts[1], parts[0]].join(' ').trim() || 'Sin nombre';
      }

      if (telLine) phone = telLine.substring(telLine.indexOf(':') + 1).trim();

      const norm = normalizePhone(phone);
      if (name !== 'Sin nombre' || norm.digits) {
        const alias = getAliasFromContactName(name);
        contacts.push({
          id: `id_${Date.now()}_${Math.random().toString(36).slice(2,10)}`,
          name: name === 'Sin nombre' && norm.digits ? norm.digits : name,
          alias,
          phone: norm.digits || '',
          phoneE164: norm.e164 || '',
          origin,
          status: 'sin revisar',
          lastUpdated: new Date().toISOString(),
          _smokyActive: false,
        });
      }
    }
    return contacts;
  }

  async function processCSVSmall(text, origin) {
    // reconoce: simple (name/number), WTK (number,name,email,tags,metadata), Planilla (usuarios/estado...)
    const delim = detectDelimiter(text);
    const lines = String(text||'').replace(/\uFEFF/g,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l => l.trim() !== '' && !/^sep=/i.test(l.trim()));
    if (lines.length < 2) return { contacts: [], info: 'CSV vacío' };

    const headers = parseCSVLine(lines[0], delim);
    const headersLower = headers.map(h => String(h||'').toLowerCase().trim());

    const idxUsuarios = findHeaderIndex(headersLower, ['usuarios']);
    const idxPlanEstado = findHeaderIndex(headersLower, ['estado de revision', 'estado', 'estado actual']);

    const idxNumber = findHeaderIndex(headersLower, ['number','telefono','tel','phone']);
    const idxName = findHeaderIndex(headersLower, ['name','nombre']);
    const idxSimpleName = findHeaderIndex(headersLower, ['name','nombre','usuario']);
    const idxSimpleNumber = findHeaderIndex(headersLower, ['number','numero','tel','telefono','phone']);

    const looksPlanilla = idxUsuarios !== -1;
    const looksWTK = (idxNumber !== -1 && idxName !== -1 && headersLower.includes('metadata'));
    const looksSimple = (idxSimpleName !== -1 && idxSimpleNumber !== -1);

    const out = [];
    if (looksPlanilla) {
      // Smoky planilla export: NO trae teléfono; usamos alias/nombre
      for (let i=1;i<lines.length;i++){
        const cols = parseCSVLine(lines[i], delim);
        const u = (cols[idxUsuarios] ?? '').trim();
        if (!u) continue;
        const statusRaw = (idxPlanEstado !== -1 ? (cols[idxPlanEstado] ?? '') : '').toUpperCase();
        const status = statusRaw.includes('JUGANDO') ? 'jugando' : 'sin revisar';
        out.push({
          id: `id_${Date.now()}_${Math.random().toString(36).slice(2,10)}`,
          name: u,
          alias: cleanAliasBase(u),
          phone: '',
          phoneE164: '',
          origin,
          status,
          lastUpdated: new Date().toISOString(),
          _smokyActive: status === 'jugando'
        });
      }
      return { contacts: out, info: 'Planilla importada (sin teléfono). Para teléfono: cargá WTK y se completa.' };
    }

    if (looksWTK) {
      // WTK contacts: number,name,email,tags,metadata
      const idxEmail = findHeaderIndex(headersLower, ['email']);
      const idxTags = findHeaderIndex(headersLower, ['tags']);
      const idxMeta = findHeaderIndex(headersLower, ['metadata']);
      for (let i=1;i<lines.length;i++){
        const cols = parseCSVLine(lines[i], delim);
        const number = (cols[idxNumber] ?? '').trim();
        const name = (cols[idxName] ?? '').trim();
        if (!name && !number) continue;
        const norm = normalizePhone(number);
        const alias = getAliasFromContactName(name);
        out.push({
          id: `id_${Date.now()}_${Math.random().toString(36).slice(2,10)}`,
          name: name || alias || (norm.e164 || norm.digits || 'Sin nombre'),
          alias,
          phone: norm.digits || '',
          phoneE164: norm.e164 || '',
          origin,
          status: 'sin revisar',
          lastUpdated: new Date().toISOString(),
          email: (cols[idxEmail] ?? '').trim(),
          tags: (cols[idxTags] ?? '').trim(),
          metadata: (cols[idxMeta] ?? '').trim(),
          _smokyActive: false
        });
      }
      return { contacts: out, info: 'WTK importado' };
    }

    // simple (name,number)
    const nameIdx = looksSimple ? idxSimpleName : 0;
    const numIdx = looksSimple ? idxSimpleNumber : 1;
    for (let i=1;i<lines.length;i++){
      const cols = parseCSVLine(lines[i], delim);
      const nameRaw = (cols[nameIdx] ?? '').trim();
      const numRaw = (cols[numIdx] ?? '').trim();
      if (!nameRaw && !numRaw) continue;
      const norm = normalizePhone(numRaw);
      if (!norm.digits) continue;
      const name = nameRaw || norm.e164;
      const alias = getAliasFromContactName(name);
      out.push({
        id: `id_${Date.now()}_${Math.random().toString(36).slice(2,10)}`,
        name,
        alias,
        phone: norm.digits || '',
        phoneE164: norm.e164 || '',
        origin,
        status: 'sin revisar',
        lastUpdated: new Date().toISOString(),
        _smokyActive: false
      });
    }
    return { contacts: out, info: 'CSV simple importado' };
  }

  /* -----------------------------
     Process Files (Masivo)
  ----------------------------- */
  async function processFiles(isFromModal=false) {
    if (AppState.filesToProcess.length === 0) return showNotification('Seleccioná al menos un archivo', 'warning');

    const originInput = isFromModal ? elements.originNameModal : elements.originName;
    const processButton = isFromModal ? elements.processFilesModal : elements.processFiles;

    processButton.disabled = true;
    processButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

    try {
      const origin = originInput.value.trim() || (isFromModal ? 'Importación Modal' : 'Importación Inicial');

      const vcfFiles = AppState.filesToProcess.filter(f => /\.vcf$/i.test(f.name) || /\.vcard$/i.test(f.name));
      const csvFiles = AppState.filesToProcess.filter(f => /\.csv$/i.test(f.name));

      // VCF
      for (const f of vcfFiles) {
        const t = await f.text();
        const parsed = parseVCF(t, origin);
        const { added, updated } = mergeIntoAppContacts(parsed, false);
        showNotification(`VCF: ${added} añadidos, ${updated} actualizados`, 'success');
      }

      // CSV (pequeños)
      for (const f of csvFiles) {
        const t = await f.text();
        const res = await processCSVSmall(t, origin);
        const { added, updated } = mergeIntoAppContacts(res.contacts, false);
        showNotification(`${f.name}: ${added} añadidos, ${updated} actualizados. ${res.info}`, 'success');
      }

      saveData();
      openMain();
      render();

    } catch (e) {
      console.error(e);
      showNotification('Error procesando archivos. Mirá la consola.', 'error');
    } finally {
      AppState.filesToProcess = [];
      renderFileList();
      originInput.value = '';
      processButton.disabled = false;
      processButton.innerHTML = isFromModal ? '<i class="fas fa-play"></i> Procesar' : '<i class="fas fa-play"></i> Procesar y Comenzar';
      if (isFromModal) elements.addMoreModal.classList.remove('active');
    }
  }

  /* -----------------------------
     Smoky UI
  ----------------------------- */
  function renderSmokyFileList(files) {
    elements.smokyFileList.innerHTML = files.map(f => `
      <div class="file-item">
        <span>${f.name}</span>
        <span class="muted">(${(f.size/1024/1024).toFixed(2)} MB)</span>
      </div>
    `).join('');
  }

  async function runSmoky() {
    const files = Array.from(elements.smokyInput.files || []);
    if (files.length < 2) return showNotification('Cargá 2 CSV: Ops + Contactos WTK', 'warning');

    // Detect which is ops vs contacts by header hints (read first ~64KB)
    const previews = await Promise.all(files.map(async f => (await f.slice(0, 65536).text()).toLowerCase()));
    const idxOps = previews.findIndex(t => t.includes('fecha') && t.includes('cantidad') && t.includes('alias'));
    const idxContacts = previews.findIndex(t => t.includes('number') && t.includes('metadata') && t.includes('name'));

    const opsFile = files[idxOps !== -1 ? idxOps : 0];
    const contactsFile = files[idxContacts !== -1 ? idxContacts : 1];

    setSmokyProgress(true, 'Inicializando Worker…', 0);
    worker.postMessage({ type:'init', preferTitular: elements.smokyPreferTitular.checked });

    const debug = elements.smokyDebug.checked;

    const waitReady = () => new Promise((resolve) => {
      const onMsg = (e) => {
        const m = e.data || {};
        if (m.type === 'ready') { worker.removeEventListener('message', onMsg); resolve(); }
      };
      worker.addEventListener('message', onMsg);
    });
    await waitReady();

    // Listen progress
    let phase = 'ops';
    const onWorker = (e) => {
      const m = e.data || {};
      if (m.type === 'progress') {
        // lightweight: we already show % by streaming
      }
      if (m.type === 'phaseDone' && m.phase === 'ops') {
        phase = 'contacts';
        setSmokyProgress(true, `Ops OK • ${m.active.toLocaleString('es-AR')} usuarios activos`, 60);
        if (debug) console.log('SMOKY ops phase done:', m);
      }
      if (m.type === 'done') {
        if (debug) console.log('SMOKY DONE:', m);
        worker.removeEventListener('message', onWorker);

        // Build contacts array for app
        const newContacts = buildContactsFromWorkerMerged(m.merged || [], 'SMOKY');

        // Reset current list (SMOKY suele ser base)
        AppState.contacts = [];
        AppState.smokyActiveSet = new Set(); // will rebuild below

        // Merge and set smokyActiveSet
        const { added, updated } = mergeIntoAppContacts(newContacts, true);
        AppState.smokyActiveSet = new Set(
          AppState.contacts.filter(c => c._smokyActive).map(c => cleanAliasBase(c.alias || getAliasFromContactName(c.name || '')))
        );

        setSmokyProgress(true, `Listo • ${AppState.contacts.length.toLocaleString('es-AR')} contactos cargados`, 100);

        saveData();
        openMain();
        render();

        setTimeout(() => setSmokyProgress(false), 900);
        showNotification(`SMOKY OK: ${added} cargados / ${updated} actualizados.`, 'success');
      }
    };
    worker.addEventListener('message', onWorker);

    // Stream ops file
    setSmokyProgress(true, 'Leyendo OPS (por chunks)…', 5);
    await streamFileToWorker(opsFile, 'ops', (pct) => {
      setSmokyProgress(true, `OPS… ${pct}%`, Math.min(55, Math.floor(pct * 0.55)));
    });

    // Stream contacts
    setSmokyProgress(true, 'Leyendo CONTACTOS WTK (por chunks)…', 60);
    await streamFileToWorker(contactsFile, 'contacts', (pct) => {
      setSmokyProgress(true, `CONTACTOS… ${pct}%`, 60 + Math.floor(pct * 0.4));
    });
  }

  /* -----------------------------
     Duplicates UI (for VCF)
  ----------------------------- */
  function handleDuplicates(duplicates) {
    return new Promise(resolve => {
      $('#duplicateCount').textContent = duplicates.length;
      const modal = $('#duplicateModal');
      modal.classList.add('active');

      const options = $$('.duplicate-option');
      options.forEach(opt => opt.onclick = () => {
        options.forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
      });

      $('#confirmDuplicateAction').onclick = () => {
        const action = $('.duplicate-option.selected').dataset.action;
        modal.classList.remove('active');
        resolve(action);
      };
    });
  }

  /* -----------------------------
     UI events
  ----------------------------- */
  function setupEventListeners() {
    // Smoky input
    elements.dropSmoky.onclick = () => elements.smokyInput.click();
    elements.smokyInput.onchange = (e) => renderSmokyFileList(Array.from(e.target.files || []));
    elements.btnSmokyProcess.onclick = runSmoky;

    elements.smokyOpenBtn.onclick = () => {
      // open upload screen already hidden? show modal-like by scrolling to top? simplest: reload page to home view is annoying.
      // We'll just alert a hint.
      showNotification('Para correr SMOKY: refrescá (F5) y usá la pantalla inicial, o cargá Ops+WTK desde cero.', 'info');
    };

    // Masivo upload
    elements.dropArea.onclick = () => elements.fileInput.click();
    elements.fileInput.onchange = (e) => addFilesToList(Array.from(e.target.files || []));
    elements.processFiles.onclick = () => processFiles(false);

    elements.dropAreaModal.onclick = () => elements.fileInputModal.click();
    elements.fileInputModal.onchange = (e) => addFilesToList(Array.from(e.target.files || []));
    elements.processFilesModal.onclick = () => processFiles(true);
    elements.cancelAddMore.onclick = () => elements.addMoreModal.classList.remove('active');

    [elements.dropArea, elements.dropAreaModal, elements.dropSmoky].forEach(area => {
      area.addEventListener('dragover', (e) => { e.preventDefault(); area.style.borderColor = 'var(--accent-primary)'; });
      area.addEventListener('dragleave', () => { area.style.borderColor = 'var(--border-color)'; });
      area.addEventListener('drop', (e) => {
        e.preventDefault();
        area.style.borderColor = 'var(--border-color)';
        const files = Array.from(e.dataTransfer.files || []);
        if (area === elements.dropSmoky) {
          // smoky wants ops+contacts
          const dt = new DataTransfer();
          files.filter(f => /\.csv$/i.test(f.name)).slice(0,2).forEach(f => dt.items.add(f));
          elements.smokyInput.files = dt.files;
          renderSmokyFileList(Array.from(elements.smokyInput.files || []));
        } else {
          addFilesToList(files);
        }
      });
    });

    // Search
    elements.searchInput.oninput = debounce(() => { AppState.currentPage = 1; render(); }, 150);

    // Filters
    $$('.stat-box').forEach(b => b.onclick = (e) => {
      $$('.stat-box').forEach(sb => sb.classList.remove('active'));
      const box = e.target.closest('.stat-box');
      box.classList.add('active');
      AppState.currentFilter = box.dataset.filter;
      AppState.currentPage = 1;
      render();
    });

    // Views
    $$('.view-btn').forEach(b => b.onclick = (e) => {
      $$('.view-btn').forEach(vb => vb.classList.remove('active'));
      const btn = e.target.closest('.view-btn');
      btn.classList.add('active');
      AppState.currentView = btn.dataset.view;
      AppState.tinderIndex = 0;
      AppState.selectedContacts.clear();
      updateView();
    });

    // Tinder
    $('#tinderNext').onclick = () => { AppState.tinderIndex++; renderTinderView(); };
    $('#tinderBack').onclick = () => {
      if (!AppState.filteredContacts.length) return;
      AppState.tinderIndex = (AppState.tinderIndex - 1 + AppState.filteredContacts.length) % AppState.filteredContacts.length;
      renderTinderView();
    };
    $$('.tinder-action-btn[data-status]').forEach(btn => btn.onclick = () => {
      if (!AppState.filteredContacts.length) return;
      const c = AppState.filteredContacts[AppState.tinderIndex];
      updateContact(c.id, 'status', btn.dataset.status);
      showNotification(`Estado cambiado a: ${btn.textContent.trim()}`, 'success');
      setTimeout(() => { AppState.tinderIndex++; renderTinderView(); }, 220);
    });

    // Pagination
    elements.pagination.onclick = (e) => {
      const page = e.target.closest('.page-btn')?.dataset.page;
      if (page) { AppState.currentPage = parseInt(page, 10); updateView(); updateBulkActionsBar(); }
    };

    // Add more
    elements.addMoreBtn.onclick = () => {
      AppState.filesToProcess = [];
      renderFileList();
      elements.addMoreModal.classList.add('active');
    };

    // Clear all
    elements.clearDataBtn.onclick = () => {
      AppState.contacts = [];
      AppState.filteredContacts = [];
      AppState.selectedContacts.clear();
      AppState.currentPage = 1;
      AppState.currentFilter = 'all';
      AppState.smokyActiveSet = new Set();
      localStorage.removeItem('nexoSmokyData_v1');
      $$('.stat-box').forEach(sb => sb.classList.remove('active'));
      $('.stat-box[data-filter="all"]').classList.add('active');
      render();
      showNotification('Todos los contactos han sido eliminados.', 'success');
    };

    // Unified click handlers for cards/list
    const unifiedEventHandler = (e) => {
      const target = e.target;
      const contactEl = target.closest('[data-id]');
      if (!contactEl) return;
      const id = contactEl.dataset.id;

      if (target.closest('.delete-contact-btn')) {
        e.stopPropagation();
        const idx = AppState.contacts.findIndex(c => c.id === id);
        if (idx !== -1) AppState.contacts.splice(idx, 1);
        AppState.selectedContacts.delete(id);
        saveData();
        render();
        showNotification('Contacto eliminado.', 'success');
        return;
      }

      if (target.closest('.status-btn')) {
        e.stopPropagation();
        const newStatus = target.closest('.status-btn').dataset.status;
        updateContact(id, 'status', newStatus);
        return;
      }

      if (target.closest('[data-field]')) {
        const text = target.textContent;
        navigator.clipboard.writeText(text).then(() => {
          showNotification(`Copiado: "${text}"`, 'info');
        }).catch(() => {});
        return;
      }

      if (target.closest('.custom-checkbox')) {
        const checkbox = $(`#check-${id}`);
        setTimeout(() => {
          if (checkbox.checked) AppState.selectedContacts.add(id);
          else AppState.selectedContacts.delete(id);
          contactEl.classList.toggle('selected', checkbox.checked);
          updateBulkActionsBar();
        }, 0);
      }
    };

    const unifiedDblClickHandler = (e) => {
      const target = e.target.closest('[data-field]');
      if (!target || target.querySelector('input')) return;
      const id = target.closest('[data-id]').dataset.id;
      const field = target.dataset.field;
      const originalValue = target.textContent;

      const contact = AppState.contacts.find(c => c.id === id);
      const prefill = (field === 'phone' && contact) ? (contact.phoneE164 || contact.phone || originalValue) : originalValue;

      target.innerHTML = `<input class="inline-edit-input" type="text" value="${prefill.replace(/"/g,'&quot;')}">`;
      const input = target.querySelector('input');
      input.focus();
      input.select();

      const save = () => {
        const newValue = input.value.trim();
        target.textContent = originalValue;
        if (newValue && newValue !== prefill) updateContact(id, field, newValue);
      };

      input.onblur = save;
      input.onkeydown = (ev) => {
        if (ev.key === 'Enter') input.blur();
        if (ev.key === 'Escape') {
          input.onblur = null;
          input.blur();
          target.textContent = originalValue;
        }
      };
    };

    ['#cardsView', '#listView'].forEach(sel => {
      const el = $(sel);
      el.addEventListener('click', unifiedEventHandler);
      el.addEventListener('dblclick', unifiedDblClickHandler);
    });

    // Bulk select all (page)
    elements.selectAllCheckbox.onchange = (e) => {
      const pageContacts = AppState.filteredContacts.slice((AppState.currentPage - 1) * AppState.itemsPerPage, AppState.currentPage * AppState.itemsPerPage);
      pageContacts.forEach(c => {
        if (e.target.checked) AppState.selectedContacts.add(c.id);
        else AppState.selectedContacts.delete(c.id);
      });
      render();
    };

    // Bulk delete
    $('#bulkDeleteBtn').onclick = () => {
      if (!AppState.selectedContacts.size) return;
      const n = AppState.selectedContacts.size;
      AppState.contacts = AppState.contacts.filter(c => !AppState.selectedContacts.has(c.id));
      AppState.selectedContacts.clear();
      saveData();
      render();
      showNotification(`${n} contactos eliminados.`, 'success');
    };

    // Bulk status
    $('#bulkStatusSelect').onchange = (e) => {
      const newStatus = e.target.value;
      if (!newStatus || !AppState.selectedContacts.size) return;
      const n = AppState.selectedContacts.size;
      AppState.selectedContacts.forEach(id => {
        const c = AppState.contacts.find(x => x.id === id);
        if (!c) return;
        c.status = newStatus;
        c.lastUpdated = new Date().toISOString();
      });
      AppState.selectedContacts.clear();
      saveData();
      render();
      showNotification(`${n} contactos actualizados a "${newStatus}".`, 'success');
    };

    $('#bulkCancelBtn').onclick = () => { AppState.selectedContacts.clear(); render(); };

    // Export modal
    elements.exportBtn.onclick = () => {
      elements.exportFilteredCount.textContent = `${AppState.filteredContacts.length.toLocaleString('es-AR')} contactos`;
      elements.exportAllCount.textContent = `${AppState.contacts.length.toLocaleString('es-AR')} contactos`;
      elements.exportModal.classList.add('active');
    };
    elements.cancelExport.onclick = () => elements.exportModal.classList.remove('active');

    elements.confirmExport.onclick = () => {
      const type = $('#exportModal .export-option[data-type].selected')?.dataset.type || 'filtered';
      const format = $('#exportModal .export-option[data-format].selected')?.dataset.format || 'excel';
      const contactsToExport = type === 'all' ? AppState.contacts : AppState.filteredContacts;

      if (format === 'excel') exportToExcel(contactsToExport);
      else if (format === 'whaticket') exportToWhaticket(contactsToExport);
      else if (format === 'vcf') exportToVCF(contactsToExport);
      else if (format === 'sheet') exportToSheetFormat(AppState.contacts);

      elements.exportModal.classList.remove('active');
    };

    $$('#exportModal .export-option').forEach(opt => opt.onclick = (e) => {
      const option = e.target.closest('.export-option');
      const group = option.dataset.type ? '[data-type]' : (option.dataset.format ? '[data-format]' : '');
      if (!group) return;
      $$(`#exportModal .export-option${group}`).forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
    });
  }

  function init() {
    try {
      elements.bulkStatusSelect.innerHTML =
        `<option value="" disabled selected>Cambiar estado</option>` +
        STATUS_OPTIONS.map(opt => `<option value="${opt.id}">${opt.label}</option>`).join('');

      setupEventListeners();
      loadData();
      render();
    } catch (e) {
      console.error(e);
      document.body.innerHTML = "<h1>Error Crítico</h1><p>La app no pudo iniciarse. Probá abrirla en Chrome actualizado.</p>";
    }
  }

  init();
})();
</script>
</body>
</html>
