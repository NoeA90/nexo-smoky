<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexo Smoky üî• ‚Äî Gestor de Contactos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --bg-primary:#0f172a;
      --bg-secondary:#1e293b;
      --bg-card:#334155;
      --accent-primary:#3b82f6;
      --accent-success:#10b981;
      --accent-warning:#f59e0b;
      --accent-danger:#ef4444;
      --accent-neutral:#6b7280;
      --accent-jugando:#8b5cf6;

      --tag-hot:#ef4444;
      --tag-high:#f59e0b;
      --tag-recontact:#3b82f6;
      --tag-promo:#10b981;
      --tag-cold:#6b7280;

      --text-primary:#f1f5f9;
      --text-secondary:#cbd5e1;
      --border-color:#475569;
      --hover-color:#475569;

      --radius: 14px;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,sans-serif}
    body{background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden}
    .container{max-width:1650px;margin:0 auto;padding:18px}

    /* Topbar */
    .navbar{
      background:var(--bg-secondary);
      padding:14px 16px;
      border-radius:var(--radius);
      margin-bottom:14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      gap:12px;
      box-shadow:0 5px 15px rgba(0,0,0,.2);
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-width:260px;
    }
    .brand .logo{
      width:38px;height:38px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(90deg,var(--accent-primary),#8b5cf6);
      box-shadow:0 8px 20px rgba(59,130,246,.25);
    }
    .brand h1{
      font-size:1.15rem;
      line-height:1.1;
    }
    .brand small{display:block;color:var(--text-secondary);font-weight:500;margin-top:2px}

    .stats{display:flex;gap:10px;flex-wrap:wrap;flex:1}
    .stat-box{
      background:var(--bg-card);
      padding:10px 12px;
      border-radius:12px;
      min-width:120px;
      text-align:center;
      cursor:pointer;
      transition:all .2s;
      border:2px solid transparent;
      user-select:none;
    }
    .stat-box:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,.18)}
    .stat-box.active{border-color:var(--accent-primary)}
    .stat-value{font-size:1.25rem;font-weight:800}
    .stat-total .stat-value{color:var(--accent-primary)}
    .stat-unreviewed .stat-value{color:#9ca3af}
    .stat-contactado .stat-value{color:var(--accent-success)}
    .stat-jugando .stat-value{color:var(--accent-jugando)}
    .stat-no-interesado .stat-value{color:var(--accent-danger)}
    .stat-sin-wsp .stat-value{color:var(--accent-neutral)}

    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      padding:10px 16px;border-radius:10px;border:none;cursor:pointer;
      font-weight:700;transition:.2s;display:inline-flex;align-items:center;gap:8px;
      background:var(--bg-card);color:var(--text-primary);
    }
    .btn:hover{transform:translateY(-2px);opacity:.95}
    .btn-success{background:var(--accent-success);color:#fff}
    .btn-danger{background:var(--accent-danger);color:#fff}
    .btn-warning{background:var(--accent-warning);color:#111827}
    .btn-primary{background:var(--accent-primary);color:#fff}

    /* Progress + conversion */
    .row-panels{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:14px;
    }
    @media (max-width: 900px){
      .row-panels{grid-template-columns:1fr}
    }
    .panel{
      background:var(--bg-secondary);
      padding:14px 16px;
      border-radius:var(--radius);
      box-shadow:0 5px 15px rgba(0,0,0,.18);
    }
    .panel-title{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:10px;gap:10px;
    }
    .panel-title h3{font-size:1rem}
    .muted{color:var(--text-secondary)}
    .progress-bar{height:12px;background:var(--bg-card);border-radius:8px;overflow:hidden;margin:8px 0 6px}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-primary),#8b5cf6);width:0%;transition:width .35s ease}
    .progress-stats{display:flex;justify-content:space-between;font-size:.9rem;color:var(--text-secondary);gap:10px;flex-wrap:wrap}
    .kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(110px,1fr));gap:10px}
    @media (max-width: 700px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}
    .kpi{
      background:var(--bg-card);
      border-radius:12px;
      padding:12px;
    }
    .kpi .label{font-size:.86rem;color:var(--text-secondary)}
    .kpi .value{font-size:1.25rem;font-weight:900;margin-top:4px}
    .kpi .sub{font-size:.85rem;color:var(--text-secondary);margin-top:4px}

    /* Filters / Search / Settings */
    .view-controls{
      display:flex;justify-content:space-between;align-items:flex-start;
      gap:12px;flex-wrap:wrap;margin-bottom:14px;
    }
    .left-stack{display:flex;flex-direction:column;gap:10px;flex:1;min-width:320px}
    .search-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .search-box{flex:1;min-width:280px;position:relative}
    .search-input{
      width:100%;padding:12px 14px 12px 44px;background:var(--bg-card);
      border:2px solid var(--border-color);border-radius:12px;color:var(--text-primary);font-size:1rem;
    }
    .search-input:focus{outline:none;border-color:var(--accent-primary)}
    .search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-secondary)}
    .filters{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .select, .input, .date{
      padding:10px 12px;background:var(--bg-card);
      border:2px solid var(--border-color);border-radius:12px;color:var(--text-primary);
      cursor:pointer;
    }
    .select:focus, .input:focus, .date:focus{
      outline:none;border-color:var(--accent-primary)
    }
    .chip-toggle{
      display:flex;align-items:center;gap:8px;
      background:var(--bg-card);
      border:2px solid var(--border-color);
      border-radius:999px;
      padding:8px 12px;
      user-select:none;
    }
    .chip-toggle input{transform:scale(1.2)}
    .view-toggle{
      display:flex;gap:6px;background:var(--bg-card);padding:6px;border-radius:12px;
    }
    .view-btn{
      padding:10px 14px;background:transparent;border:none;color:var(--text-secondary);
      border-radius:10px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:8px;font-weight:800;
    }
    .view-btn.active{background:var(--accent-primary);color:#fff}

    .settings{
      background:var(--bg-secondary);
      border-radius:var(--radius);
      padding:12px;
      min-width:320px;
      max-width:520px;
      box-shadow:0 5px 15px rgba(0,0,0,.18);
    }
    .settings h4{font-size:1rem;margin-bottom:8px;color:var(--accent-primary)}
    .settings textarea{
      width:100%;
      min-height:84px;
      resize:vertical;
      padding:10px 12px;
      border-radius:12px;
      border:2px solid var(--border-color);
      background:var(--bg-card);
      color:var(--text-primary);
      outline:none;
    }
    .settings textarea:focus{border-color:var(--accent-primary)}
    .help-line{font-size:.86rem;color:var(--text-secondary);margin-top:8px;line-height:1.25}

    /* Views */
    .cards-view{
      display:none;
      grid-template-columns:repeat(auto-fill,minmax(360px,1fr));
      gap:14px;
      margin-bottom:18px;
    }
    .cards-view.active{display:grid}
    .contact-card{
      background:var(--bg-card);
      border-radius:16px;
      padding:16px;
      border-left:6px solid var(--accent-neutral);
      position:relative;
      box-shadow:0 5px 15px rgba(0,0,0,.12);
      transition:.2s;
    }
    .contact-card:hover{transform:translateY(-3px);box-shadow:0 12px 26px rgba(0,0,0,.2)}
    .contact-card[data-status="jugando"]{border-left-color:var(--accent-jugando)}
    .contact-card[data-status="contactado"]{border-left-color:var(--accent-success)}
    .contact-card[data-status="no interesado"]{border-left-color:var(--accent-danger)}
    .contact-card[data-status="sin wsp"]{border-left-color:var(--accent-neutral)}
    .contact-card[data-status="sin revisar"]{border-left-color:#9ca3af}

    .badge-status{
      position:absolute;top:12px;right:12px;
      padding:6px 10px;border-radius:999px;font-size:.8rem;font-weight:900;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      letter-spacing:.3px;
      display:flex;align-items:center;gap:8px;
    }
    .badge-dot{width:10px;height:10px;border-radius:50%}
    .dot-sin-revisar{background:#9ca3af}
    .dot-jugando{background:var(--accent-jugando)}
    .dot-contactado{background:var(--accent-success)}
    .dot-no-interesado{background:var(--accent-danger)}
    .dot-sin-wsp{background:var(--accent-neutral)}

    .contact-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px}
    .contact-name{font-size:1.15rem;font-weight:900;cursor:pointer;padding:6px 8px;border-radius:10px;transition:.15s;max-width:70%;word-break:break-word}
    .contact-name:hover{background:rgba(255,255,255,.08)}
    .pill{background:var(--bg-secondary);padding:5px 10px;border-radius:999px;font-size:.82rem;color:var(--text-secondary);white-space:nowrap}
    .contact-info{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .contact-phone{font-size:1.02rem;color:var(--text-secondary)}
    .whatsapp-btn{
      background:#25D366;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;
      display:inline-flex;align-items:center;gap:8px;width:fit-content;transition:.2s;font-weight:800
    }
    .whatsapp-btn:hover{background:#128C7E;transform:translateY(-2px)}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .tag{
      font-size:.78rem;font-weight:900;padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      display:inline-flex;align-items:center;gap:8px;
    }
    .tag .t-dot{width:10px;height:10px;border-radius:50%}
    .t-high{background:var(--tag-high)}
    .t-hot{background:var(--tag-hot)}
    .t-recontact{background:var(--tag-recontact)}
    .t-promo{background:var(--tag-promo)}
    .t-cold{background:var(--tag-cold)}
    .tag-empty{color:var(--text-secondary);font-weight:700}

    .meta-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .meta-field label{
      display:block;font-size:.82rem;color:var(--text-secondary);margin-bottom:6px;font-weight:800;
    }
    .meta-field input, .meta-field select{
      width:100%;
      padding:9px 10px;border-radius:12px;border:2px solid var(--border-color);
      background:var(--bg-secondary);color:var(--text-primary);
    }
    .meta-field input:focus, .meta-field select:focus{outline:none;border-color:var(--accent-primary)}
    .notes{
      margin-top:10px;
    }
    .notes label{display:block;font-size:.82rem;color:var(--text-secondary);margin-bottom:6px;font-weight:800}
    .notes textarea{
      width:100%;
      min-height:64px;
      resize:vertical;
      padding:9px 10px;border-radius:12px;border:2px solid var(--border-color);
      background:var(--bg-secondary);color:var(--text-primary);
      outline:none;
    }
    .notes textarea:focus{border-color:var(--accent-primary)}
    .actions{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;
    }
    .small-btn{
      padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:900;transition:.2s;
      display:inline-flex;align-items:center;gap:8px;
    }
    .small-btn:hover{transform:translateY(-2px);opacity:.95}
    .btn-outline-danger{
      background:transparent;border:2px solid var(--accent-danger);color:var(--accent-danger);
    }
    .btn-outline-danger:hover{background:var(--accent-danger);color:#fff}
    .status-select{
      flex:1;min-width:170px;padding:9px 10px;border-radius:12px;border:2px solid var(--border-color);
      background:var(--bg-secondary);color:var(--text-primary);
    }

    /* List view */
    .list-view{display:none;flex-direction:column;gap:10px;margin-bottom:18px}
    .list-view.active{display:flex}
    .list-item{
      background:var(--bg-card);
      border-radius:14px;
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;
      border-left:5px solid var(--accent-neutral);
      transition:.2s;
    }
    .list-item:hover{transform:translateX(4px);box-shadow:0 10px 20px rgba(0,0,0,.18)}
    .list-item[data-status="jugando"]{border-left-color:var(--accent-jugando)}
    .list-item[data-status="contactado"]{border-left-color:var(--accent-success)}
    .list-item[data-status="no interesado"]{border-left-color:var(--accent-danger)}
    .list-item[data-status="sin wsp"]{border-left-color:var(--accent-neutral)}
    .list-item[data-status="sin revisar"]{border-left-color:#9ca3af}

    .list-left{flex:1;min-width:260px}
    .list-name{font-weight:900;font-size:1.05rem;cursor:pointer;padding:6px 8px;border-radius:10px;display:inline-block}
    .list-name:hover{background:rgba(255,255,255,.08)}
    .list-details{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;color:var(--text-secondary);font-size:.9rem}
    .list-right{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .list-right .select, .list-right .date {padding:8px 10px;border-radius:12px}
    .list-right .mini{padding:8px 10px;border-radius:12px}
    .mini{background:var(--bg-secondary);border:2px solid var(--border-color);color:var(--text-primary);cursor:pointer;font-weight:900}
    .mini:hover{border-color:var(--accent-primary)}

    /* Tinder */
    .tinder-view{
      display:none;flex-direction:column;align-items:center;justify-content:center;
      min-height:64vh;margin-bottom:18px;position:relative;
    }
    .tinder-view.active{display:flex}
    .tinder-card{
      background:var(--bg-card);
      border-radius:22px;
      padding:28px;
      max-width:650px;width:95%;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      border:2px solid transparent;
      text-align:center;
      position:relative;
    }
    .tinder-card[data-status="jugando"]{border-color:var(--accent-jugando)}
    .tinder-card[data-status="contactado"]{border-color:var(--accent-success)}
    .tinder-card[data-status="no interesado"]{border-color:var(--accent-danger)}
    .tinder-card[data-status="sin wsp"]{border-color:var(--accent-neutral)}
    .tinder-card[data-status="sin revisar"]{border-color:#9ca3af}

    .tinder-name{font-size:2rem;font-weight:950;margin-bottom:8px;cursor:pointer;padding:10px 12px;border-radius:16px;display:inline-block}
    .tinder-name:hover{background:rgba(255,255,255,.08)}
    .tinder-origin{display:inline-block;margin-top:6px}
    .tinder-phone{font-size:1.25rem;margin:16px 0;color:var(--text-secondary)}
    .tinder-actions{
      display:grid;grid-template-columns:repeat(4,1fr);
      gap:10px;margin-top:18px;
    }
    @media (max-width: 720px){.tinder-actions{grid-template-columns:repeat(2,1fr)}}
    .tinder-btn{
      padding:14px 10px;border-radius:14px;border:none;cursor:pointer;font-weight:950;color:#fff;
      display:flex;flex-direction:column;align-items:center;gap:6px;transition:.2s;
    }
    .tinder-btn:hover{transform:translateY(-2px);opacity:.95}
    .tb-jugando{background:var(--accent-jugando)}
    .tb-contactado{background:var(--accent-success)}
    .tb-no-interesado{background:var(--accent-danger)}
    .tb-sin-wsp{background:var(--accent-neutral)}
    .tb-sin-revisar{background:#9ca3af;color:#111827}
    .tb-next{background:var(--accent-primary);grid-column:span 4}
    @media (max-width: 720px){.tb-next{grid-column:span 2}}
    .tinder-counter{
      position:absolute;top:12px;right:12px;
      background:var(--bg-secondary);
      padding:8px 12px;border-radius:999px;font-weight:900;
      color:var(--text-primary);
    }
    .tinder-hints{
      margin-top:10px;color:var(--text-secondary);font-size:.88rem;line-height:1.3;text-align:center;
    }
    .tinder-meta{
      margin-top:14px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      text-align:left;
    }
    @media (max-width: 720px){.tinder-meta{grid-template-columns:1fr}}
    .tinder-meta .box{
      background:var(--bg-secondary);
      border:2px solid var(--border-color);
      border-radius:16px;
      padding:12px;
    }
    .tinder-meta label{display:block;font-size:.82rem;color:var(--text-secondary);font-weight:900;margin-bottom:6px}
    .tinder-meta input, .tinder-meta select, .tinder-meta textarea{
      width:100%;
      padding:9px 10px;border-radius:12px;border:2px solid var(--border-color);
      background:var(--bg-card);color:var(--text-primary);outline:none;
    }
    .tinder-meta textarea{min-height:72px;resize:vertical}
    .tinder-meta input:focus, .tinder-meta select:focus, .tinder-meta textarea:focus{border-color:var(--accent-primary)}

    /* Pagination */
    .pagination{
      display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap;
      margin:10px 0 22px;
    }
    .page-btn{
      padding:10px 12px;border-radius:12px;background:var(--bg-secondary);border:none;color:var(--text-primary);
      cursor:pointer;font-weight:900;transition:.2s;
    }
    .page-btn:hover{background:var(--hover-color)}
    .page-btn.active{background:var(--accent-primary)}
    .page-btn:disabled{opacity:.55;cursor:not-allowed}

    /* Modals */
    .modal{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.8);
      display:flex;justify-content:center;align-items:center;
      z-index:5000;
      opacity:0;pointer-events:none;transition:.2s;
    }
    .modal.active{opacity:1;pointer-events:all}
    .modal-content{
      background:var(--bg-secondary);
      padding:18px;
      border-radius:18px;
      max-width:720px;width:94%;
      box-shadow:0 30px 90px rgba(0,0,0,.55);
      border:2px solid rgba(59,130,246,.35);
    }
    .modal h3{font-size:1.25rem;margin-bottom:10px;color:var(--accent-primary)}
    .modal p{color:var(--text-secondary);margin-bottom:12px;white-space:pre-line}
    .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 700px){.modal-grid{grid-template-columns:1fr}}
    .modal-box{
      background:var(--bg-card);
      border-radius:16px;
      padding:12px;
      border:2px solid transparent;
    }
    .modal-box h4{font-size:1rem;margin-bottom:6px}
    .radio-row{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .radio{
      display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px;
    }
    .radio input{transform:scale(1.2)}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:14px}
    .modal-actions .btn{border-radius:12px}

    /* Upload screen */
    .upload-screen{
      position:fixed;top:0;left:0;width:100%;height:100vh;
      background:linear-gradient(135deg,var(--bg-primary) 0%, #1e1b4b 100%);
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      z-index:8000;transition:opacity .35s ease;
    }
    .upload-screen.hidden{opacity:0;pointer-events:none}
    .upload-card{
      background:var(--bg-secondary);padding:22px;border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      max-width:620px;width:92%;
      text-align:center;border:2px solid var(--accent-primary);
    }
    .upload-card h1{
      margin:8px 0 8px;font-size:2rem;
      background:linear-gradient(90deg,var(--accent-primary),#8b5cf6);
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .upload-card .sub{color:var(--text-secondary);margin-bottom:14px}
    .file-upload-area{
      border:3px dashed var(--border-color);
      border-radius:16px;padding:18px;margin:14px 0;cursor:pointer;transition:.2s
    }
    .file-upload-area:hover{border-color:var(--accent-primary);background:rgba(59,130,246,.06)}
    .file-upload-area i{font-size:2.3rem;color:var(--accent-primary);margin-bottom:8px}
    .origin-input{
      width:100%;padding:12px 14px;margin:10px 0;
      background:var(--bg-card);
      border:2px solid var(--border-color);
      border-radius:12px;
      color:var(--text-primary);
      font-size:1rem;
    }
    .origin-input:focus{outline:none;border-color:var(--accent-primary)}
    .file-list{margin-top:10px;max-height:170px;overflow:auto;text-align:left}
    .file-item{
      background:var(--bg-card);padding:10px 12px;margin:6px 0;border-radius:12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px
    }

    /* Notification */
    .notification{
      position:fixed;top:18px;right:18px;
      padding:14px 18px;border-radius:14px;color:#fff;font-weight:900;
      z-index:9999;
      transform:translateX(150%);transition:transform .45s cubic-bezier(.68,-.55,.265,1.55);
      max-width:420px;
      white-space:pre-line;
    }
    .notification.show{transform:translateX(0)}
    .notification.success{background:var(--accent-success)}
    .notification.info{background:var(--accent-primary)}
    .notification.warning{background:var(--accent-warning);color:#111827}
    .notification.error{background:var(--accent-danger)}
    ::-webkit-scrollbar{width:10px}
    ::-webkit-scrollbar-track{background:var(--bg-secondary)}
    ::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:8px}
    ::-webkit-scrollbar-thumb:hover{background:var(--accent-primary)}
  </style>
</head>
<body>

  <!-- Upload -->
  <div class="upload-screen" id="uploadScreen" style="display:none;">
    <div class="upload-card">
      <i class="fas fa-address-book" style="font-size:3.2rem;color:var(--accent-primary)"></i>
      <h1>Nexo Smoky üî•</h1>
      <div class="sub">
        Sub√≠ <b>VCF</b> (y si quer√©s tambi√©n <b>CSV</b>) desde distintos or√≠genes y gestion√° 30.000+ contactos sin que se trabe.
      </div>

      <div class="file-upload-area" id="dropArea">
        <i class="fas fa-cloud-upload-alt"></i>
        <h3>Arrastr√° y solt√° archivos VCF / CSV</h3>
        <p class="muted">o hac√© clic para seleccionar</p>
        <input type="file" id="fileInput" multiple accept=".vcf,.vcard,.csv" style="display:none;">
      </div>

      <input type="text" class="origin-input" id="originName" placeholder="Origen (ej: Pc05 / Celular Ventas / Whaticket)"/>

      <div class="file-list" id="fileList"></div>

      <button class="btn btn-primary" id="processFiles" style="width:100%;justify-content:center;">
        <i class="fas fa-play"></i> Procesar Archivos y Comenzar
      </button>

      <div class="help-line" style="margin-top:10px;text-align:left">
        <b>Anti-duplicados:</b> detectamos repetidos por n√∫mero. Te vamos a dejar elegir:
        <b>Omitir</b> / <b>Actualizar</b> / <b>Fusionar</b>.
      </div>
    </div>
  </div>

  <div class="container" id="mainInterface" style="display:none;">

    <div class="navbar">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-fire"></i></div>
        <div>
          <h1>Nexo Smoky ‚Äî Gestor de Contactos</h1>
          <small>LocalStorage optimizado ‚Ä¢ Etiquetas ‚Ä¢ Recontacto ‚Ä¢ Tinder con atajos</small>
        </div>
      </div>

      <div class="stats" id="statusStats">
        <div class="stat-box stat-total active" data-filter="all">
          <div class="stat-value" id="totalContacts">0</div>
          <div>Total</div>
        </div>
        <div class="stat-box stat-unreviewed" data-filter="sin revisar">
          <div class="stat-value" id="unreviewedContacts">0</div>
          <div>Sin revisar</div>
        </div>
        <div class="stat-box stat-contactado" data-filter="contactado">
          <div class="stat-value" id="contactedContacts">0</div>
          <div>Contactado</div>
        </div>
        <div class="stat-box stat-jugando" data-filter="jugando">
          <div class="stat-value" id="playingContacts">0</div>
          <div>Jugando</div>
        </div>
        <div class="stat-box stat-no-interesado" data-filter="no interesado">
          <div class="stat-value" id="notInterestedContacts">0</div>
          <div>No interesado</div>
        </div>
        <div class="stat-box stat-sin-wsp" data-filter="sin wsp">
          <div class="stat-value" id="noWhatsappContacts">0</div>
          <div>Sin WSP</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-success" id="exportBtn"><i class="fas fa-file-export"></i> Exportar</button>
        <button class="btn btn-warning" id="addMoreBtn"><i class="fas fa-plus"></i> Agregar</button>
        <button class="btn btn-danger" id="clearDataBtn"><i class="fas fa-trash"></i> Borrar</button>
      </div>
    </div>

    <div class="row-panels">
      <div class="panel">
        <div class="panel-title">
          <h3>Progreso de revisi√≥n</h3>
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="muted" id="progressPercentage">0%</span>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-stats">
          <span id="reviewedCount">0 revisados</span>
          <span id="totalCount">0 totales</span>
          <span id="dueTodayCount">0 vencen hoy</span>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">
          <h3>M√©tricas PRO</h3>
          <span class="muted">Conversi√≥n + calidad de base</span>
        </div>
        <div class="kpi-grid">
          <div class="kpi">
            <div class="label">Jugando / Contactados</div>
            <div class="value" id="kpiConv1">0%</div>
            <div class="sub" id="kpiConv1Sub">0 / 0</div>
          </div>
          <div class="kpi">
            <div class="label">Jugando / Total</div>
            <div class="value" id="kpiConv2">0%</div>
            <div class="sub" id="kpiConv2Sub">0 / 0</div>
          </div>
          <div class="kpi">
            <div class="label">Contactados / Total</div>
            <div class="value" id="kpiConv3">0%</div>
            <div class="sub" id="kpiConv3Sub">0 / 0</div>
          </div>
          <div class="kpi">
            <div class="label">Recontacto (hoy)</div>
            <div class="value" id="kpiDueToday">0</div>
            <div class="sub">Pr√≥ximo contacto = hoy</div>
          </div>
        </div>
      </div>
    </div>

    <div class="view-controls">
      <div class="left-stack">
        <div class="search-row">
          <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input class="search-input" id="searchInput" placeholder="Buscar por nombre / n√∫mero / origen / tags / notas / operador..." />
          </div>

          <div class="filters">
            <select class="select" id="originFilter">
              <option value="all">Origen: Todos</option>
            </select>

            <select class="select" id="tagFilter">
              <option value="all">Etiqueta: Todas</option>
              <option value="alta prioridad">üî• Alta prioridad</option>
              <option value="potencial alto">üí∞ Potencial alto</option>
              <option value="recontactar">üìÖ Recontactar</option>
              <option value="promo enviada">üéÅ Promo enviada</option>
              <option value="fr√≠o">üßä Fr√≠o</option>
            </select>

            <select class="select" id="operatorFilter">
              <option value="all">Operador: Todos</option>
            </select>

            <div class="chip-toggle" title="Mostrar s√≥lo los que vencen hoy (Pr√≥ximo contacto = hoy)">
              <input type="checkbox" id="dueTodayOnly"/>
              <label for="dueTodayOnly" style="cursor:pointer;font-weight:900;">Vencen hoy</label>
            </div>

            <select class="select" id="dueInDays">
              <option value="0">Vencen en: ‚Äî</option>
              <option value="1">‚â§ 1 d√≠a</option>
              <option value="2">‚â§ 2 d√≠as</option>
              <option value="3">‚â§ 3 d√≠as</option>
              <option value="7">‚â§ 7 d√≠as</option>
            </select>
          </div>
        </div>

        <div class="view-toggle">
          <button class="view-btn active" data-view="cards"><i class="fas fa-th-large"></i> Tarjetas</button>
          <button class="view-btn" data-view="list"><i class="fas fa-list"></i> Lista</button>
          <button class="view-btn" data-view="tinder"><i class="fas fa-fire"></i> Revisi√≥n</button>
        </div>
      </div>

      <div class="settings">
        <h4><i class="fa-brands fa-whatsapp"></i> Mensaje predefinido (WhatsApp)</h4>
        <textarea id="waTemplate"></textarea>
        <div class="help-line">
          Variables: <b>{name}</b> <b>{origin}</b> <b>{tags}</b> <b>{notes}</b><br/>
          Ejemplo r√°pido: ‚ÄúHola {name} üëã ¬øQuer√©s activar tu bono hoy?‚Äù
        </div>
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn-primary" id="saveSettingsBtn"><i class="fas fa-save"></i> Guardar</button>
          <button class="btn" id="resetTemplateBtn"><i class="fas fa-rotate-left"></i> Plantilla default</button>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-bottom:14px;">
      <div class="panel-title">
        <h3>Calidad por Origen / Operador</h3>
        <span class="muted">Top r√°pido para decidir qu√© bases sirven</span>
      </div>
      <div class="modal-grid">
        <div class="modal-box">
          <h4><i class="fa-solid fa-layer-group"></i> Por origen</h4>
          <div id="statsByOrigin" class="muted" style="margin-top:8px;line-height:1.35"></div>
        </div>
        <div class="modal-box">
          <h4><i class="fa-solid fa-user-group"></i> Por operador</h4>
          <div id="statsByOperator" class="muted" style="margin-top:8px;line-height:1.35"></div>
        </div>
      </div>
    </div>

    <!-- Views -->
    <div class="cards-view active" id="cardsView"></div>
    <div class="list-view" id="listView"></div>

    <div class="tinder-view" id="tinderView">
      <div class="tinder-counter" id="tinderCounter">0 / 0</div>
      <div class="tinder-card" id="tinderCard" data-status="sin revisar">
        <div>
          <div class="tinder-name" id="tinderName">‚Äî</div>
          <div class="pill tinder-origin" id="tinderOrigin">‚Äî</div>
          <div class="tinder-phone" id="tinderPhone">‚Äî</div>
          <a class="whatsapp-btn" id="tinderWhatsapp" target="_blank" href="#">
            <i class="fab fa-whatsapp"></i> Abrir WhatsApp
          </a>

          <div class="tinder-actions">
            <button class="tinder-btn tb-no-interesado" data-action="setStatus" data-status="no interesado">
              <i class="fa-solid fa-xmark"></i>
              <span>No interesado</span>
              <small>‚Üê</small>
            </button>
            <button class="tinder-btn tb-sin-wsp" data-action="setStatus" data-status="sin wsp">
              <i class="fa-solid fa-ban"></i>
              <span>Sin WSP</span>
              <small>‚Üì</small>
            </button>
            <button class="tinder-btn tb-contactado" data-action="setStatus" data-status="contactado">
              <i class="fa-solid fa-message"></i>
              <span>Contactado</span>
              <small>‚Üë</small>
            </button>
            <button class="tinder-btn tb-jugando" data-action="setStatus" data-status="jugando">
              <i class="fa-solid fa-fire"></i>
              <span>Jugando</span>
              <small>‚Üí</small>
            </button>

            <button class="tinder-btn tb-sin-revisar" data-action="setStatus" data-status="sin revisar">
              <i class="fa-solid fa-rotate-left"></i>
              <span>Sin revisar</span>
            </button>

            <button class="tinder-btn tb-next" data-action="next">
              <i class="fa-solid fa-forward"></i>
              <span>Siguiente</span>
              <small>Espacio</small>
            </button>
          </div>

          <div class="tinder-hints">
            Atajos: <b>‚Üê</b> No interesado ‚Ä¢ <b>‚Üí</b> Jugando ‚Ä¢ <b>‚Üë</b> Contactado ‚Ä¢ <b>‚Üì</b> Sin WSP ‚Ä¢ <b>Espacio</b> Siguiente
          </div>

          <div class="tinder-meta">
            <div class="box">
              <label>Pr√≥ximo contacto</label>
              <input type="date" id="tinderNextContact"/>
              <div style="margin-top:10px">
                <label style="margin-bottom:6px">Asignado a</label>
                <select id="tinderOperator"></select>
              </div>
            </div>

            <div class="box">
              <label>Etiquetas</label>
              <select id="tinderTagQuick">
                <option value="">+ Agregar etiqueta‚Ä¶</option>
                <option value="alta prioridad">üî• Alta prioridad</option>
                <option value="potencial alto">üí∞ Potencial alto</option>
                <option value="recontactar">üìÖ Recontactar</option>
                <option value="promo enviada">üéÅ Promo enviada</option>
                <option value="fr√≠o">üßä Fr√≠o</option>
              </select>
              <div class="tags" id="tinderTags" style="margin-top:10px"></div>
              <div style="margin-top:10px">
                <label style="margin-bottom:6px">Notas r√°pidas</label>
                <textarea id="tinderNotes" placeholder="Ej: Pidi√≥ bono 50% / Carga el viernes / No le anda MP..."></textarea>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Export modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <h3><i class="fas fa-file-export"></i> Exportar</h3>
      <p id="exportWarning"></p>

      <div class="modal-grid">
        <div class="modal-box">
          <h4>Formato</h4>
          <div class="radio-row">
            <label class="radio"><input type="radio" name="exportFormat" value="csv" checked> CSV (Excel)</label>
            <label class="radio"><input type="radio" name="exportFormat" value="vcf"> VCF (vCard)</label>
          </div>
        </div>

        <div class="modal-box">
          <h4>Alcance</h4>
          <div class="radio-row">
            <label class="radio"><input type="radio" name="exportScope" value="all" checked> Todos</label>
            <label class="radio"><input type="radio" name="exportScope" value="current"> Filtro actual (lo que est√°s viendo)</label>
            <label class="radio"><input type="radio" name="exportScope" value="dueToday"> Solo ‚ÄúVencen hoy‚Äù</label>
            <label class="radio"><input type="radio" name="exportScope" value="status"> Por estado‚Ä¶</label>
          </div>
          <div style="margin-top:10px">
            <select class="select" id="exportStatusPick" style="width:100%">
              <option value="sin revisar">Sin revisar</option>
              <option value="contactado">Contactado</option>
              <option value="jugando">Jugando</option>
              <option value="no interesado">No interesado</option>
              <option value="sin wsp">Sin WSP</option>
            </select>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="cancelExport">Cancelar</button>
        <button class="btn btn-success" id="confirmExport"><i class="fas fa-check"></i> Exportar</button>
      </div>
    </div>
  </div>

  <!-- Dedup modal -->
  <div class="modal" id="dedupModal">
    <div class="modal-content">
      <h3><i class="fa-solid fa-copy"></i> Duplicados detectados</h3>
      <p id="dedupInfo"></p>

      <div class="modal-grid">
        <div class="modal-box">
          <h4>¬øQu√© hacemos con repetidos?</h4>
          <div class="radio-row">
            <label class="radio"><input type="radio" name="dedupAction" value="skip" checked> Omitir repetidos</label>
            <label class="radio"><input type="radio" name="dedupAction" value="update"> Actualizar datos del existente</label>
            <label class="radio"><input type="radio" name="dedupAction" value="merge"> Fusionar (tags + notas)</label>
          </div>
        </div>
        <div class="modal-box">
          <h4>Tip</h4>
          <div class="muted" style="line-height:1.35">
            <b>Actualizar:</b> reemplaza nombre/origen si viene mejor.<br/>
            <b>Fusionar:</b> mantiene estado ‚Äúm√°s avanzado‚Äù y suma tags/notas.
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="dedupCancel">Cancelar carga</button>
        <button class="btn btn-primary" id="dedupApply"><i class="fas fa-check"></i> Aplicar y continuar</button>
      </div>
    </div>
  </div>

  <div class="notification" id="notification"></div>

<script>
(() => {
  /***********************
   * NEXO SMOKY ‚Äî STATE
   ***********************/
  const STORAGE_KEY = 'nexoSmokyData_v1';
  const DEFAULT_WA_TEMPLATE =
`Hola {name} üëã
Te contacto por tu usuario.
¬øQuer√©s activar tu bono de bienvenida hoy?

Origen: {origin}`;

  const STATUS = [
    { id:'sin revisar', label:'Sin revisar', dot:'dot-sin-revisar' },
    { id:'jugando', label:'Jugando', dot:'dot-jugando' },
    { id:'contactado', label:'Contactado', dot:'dot-contactado' },
    { id:'no interesado', label:'No interesado', dot:'dot-no-interesado' },
    { id:'sin wsp', label:'Sin WSP', dot:'dot-sin-wsp' },
  ];

  const TAGS = [
    { id:'alta prioridad', label:'üî• Alta prioridad', cls:'t-hot' },
    { id:'potencial alto', label:'üí∞ Potencial alto', cls:'t-high' },
    { id:'recontactar', label:'üìÖ Recontactar', cls:'t-recontact' },
    { id:'promo enviada', label:'üéÅ Promo enviada', cls:'t-promo' },
    { id:'fr√≠o', label:'üßä Fr√≠o', cls:'t-cold' },
  ];

  // Operadores: si no los defin√≠s, va a usar ‚ÄúSin asignar‚Äù.
  const DEFAULT_OPERATORS = ['Sin asignar'];

  const App = {
    contacts: [],        // array of contact objects
    byId: Object.create(null),
    byPhone: Object.create(null), // normalized phone -> contactId
    origins: new Set(),
    operators: new Set(DEFAULT_OPERATORS),

    // view state
    currentView: 'cards',
    currentFilterStatus: 'all',
    searchQuery: '',
    originFilter: 'all',
    tagFilter: 'all',
    operatorFilter: 'all',
    dueTodayOnly: false,
    dueInDays: 0,

    filteredIds: [],
    currentPage: 1,
    pageSizeCards: 60,
    pageSizeList: 120,

    tinderIndex: 0,

    // settings
    waTemplate: DEFAULT_WA_TEMPLATE,

    // saving
    dirty: false,
    saveTimer: null,
  };

  /***********************
   * DOM
   ***********************/
  const el = {
    uploadScreen: document.getElementById('uploadScreen'),
    mainInterface: document.getElementById('mainInterface'),
    dropArea: document.getElementById('dropArea'),
    fileInput: document.getElementById('fileInput'),
    fileList: document.getElementById('fileList'),
    originName: document.getElementById('originName'),
    processFiles: document.getElementById('processFiles'),

    // top stats
    totalContacts: document.getElementById('totalContacts'),
    unreviewedContacts: document.getElementById('unreviewedContacts'),
    contactedContacts: document.getElementById('contactedContacts'),
    playingContacts: document.getElementById('playingContacts'),
    notInterestedContacts: document.getElementById('notInterestedContacts'),
    noWhatsappContacts: document.getElementById('noWhatsappContacts'),

    progressPercentage: document.getElementById('progressPercentage'),
    progressFill: document.getElementById('progressFill'),
    reviewedCount: document.getElementById('reviewedCount'),
    totalCount: document.getElementById('totalCount'),
    dueTodayCount: document.getElementById('dueTodayCount'),

    // kpis
    kpiConv1: document.getElementById('kpiConv1'),
    kpiConv1Sub: document.getElementById('kpiConv1Sub'),
    kpiConv2: document.getElementById('kpiConv2'),
    kpiConv2Sub: document.getElementById('kpiConv2Sub'),
    kpiConv3: document.getElementById('kpiConv3'),
    kpiConv3Sub: document.getElementById('kpiConv3Sub'),
    kpiDueToday: document.getElementById('kpiDueToday'),

    statsByOrigin: document.getElementById('statsByOrigin'),
    statsByOperator: document.getElementById('statsByOperator'),

    // controls
    exportBtn: document.getElementById('exportBtn'),
    addMoreBtn: document.getElementById('addMoreBtn'),
    clearDataBtn: document.getElementById('clearDataBtn'),

    searchInput: document.getElementById('searchInput'),
    originFilter: document.getElementById('originFilter'),
    tagFilter: document.getElementById('tagFilter'),
    operatorFilter: document.getElementById('operatorFilter'),
    dueTodayOnly: document.getElementById('dueTodayOnly'),
    dueInDays: document.getElementById('dueInDays'),

    viewButtons: document.querySelectorAll('.view-btn'),
    statBoxes: document.querySelectorAll('.stat-box'),

    waTemplate: document.getElementById('waTemplate'),
    saveSettingsBtn: document.getElementById('saveSettingsBtn'),
    resetTemplateBtn: document.getElementById('resetTemplateBtn'),

    // views
    cardsView: document.getElementById('cardsView'),
    listView: document.getElementById('listView'),
    tinderView: document.getElementById('tinderView'),
    pagination: document.getElementById('pagination'),

    // tinder
    tinderCard: document.getElementById('tinderCard'),
    tinderName: document.getElementById('tinderName'),
    tinderOrigin: document.getElementById('tinderOrigin'),
    tinderPhone: document.getElementById('tinderPhone'),
    tinderWhatsapp: document.getElementById('tinderWhatsapp'),
    tinderCounter: document.getElementById('tinderCounter'),
    tinderNextContact: document.getElementById('tinderNextContact'),
    tinderOperator: document.getElementById('tinderOperator'),
    tinderTagQuick: document.getElementById('tinderTagQuick'),
    tinderTags: document.getElementById('tinderTags'),
    tinderNotes: document.getElementById('tinderNotes'),

    // modals
    exportModal: document.getElementById('exportModal'),
    exportWarning: document.getElementById('exportWarning'),
    cancelExport: document.getElementById('cancelExport'),
    confirmExport: document.getElementById('confirmExport'),
    exportStatusPick: document.getElementById('exportStatusPick'),

    dedupModal: document.getElementById('dedupModal'),
    dedupInfo: document.getElementById('dedupInfo'),
    dedupCancel: document.getElementById('dedupCancel'),
    dedupApply: document.getElementById('dedupApply'),

    notification: document.getElementById('notification'),
  };

  /***********************
   * UTIL
   ***********************/
  function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text ?? '';
    return div.innerHTML;
  }

  function normText(s){
    return (s ?? '').toString().toLowerCase().trim()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }

  function normPhone(phone){
    return (phone ?? '').toString().replace(/\D/g,'');
  }

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function parseISODate(s){
    if (!s) return null;
    const d = new Date(s);
    if (Number.isNaN(d.getTime())) return null;
    return d;
  }

  function daysBetweenISO(fromISO, toISO){
    if (!fromISO || !toISO) return null;
    const a = new Date(fromISO + 'T00:00:00');
    const b = new Date(toISO + 'T00:00:00');
    if (Number.isNaN(a.getTime()) || Number.isNaN(b.getTime())) return null;
    const ms = b.getTime() - a.getTime();
    return Math.round(ms / 86400000);
  }

  function showNotification(message, type='info'){
    el.notification.textContent = message;
    el.notification.className = `notification ${type}`;
    el.notification.classList.add('show');
    setTimeout(() => el.notification.classList.remove('show'), 3200);
  }

  function pickStatusLabel(id){
    return STATUS.find(s=>s.id===id)?.label ?? id;
  }

  function statusDotClass(id){
    return STATUS.find(s=>s.id===id)?.dot ?? 'dot-sin-revisar';
  }

  function tagInfo(id){
    return TAGS.find(t=>t.id===id);
  }

  function ensureContactDefaults(c){
    c.status = c.status || 'sin revisar';
    c.origin = c.origin || '‚Äî';
    c.name = c.name || 'Sin nombre';
    c.phone = c.phone || '';
    c.tags = Array.isArray(c.tags) ? c.tags : [];
    c.notes = c.notes || '';
    c.nextContact = c.nextContact || ''; // ISO yyyy-mm-dd
    c.assignedTo = c.assignedTo || 'Sin asignar';
    c.lastUpdated = c.lastUpdated || new Date().toISOString();
    c._k = c._k || buildSearchKey(c);
  }

  function buildSearchKey(c){
    const tags = (c.tags||[]).join(' ');
    return [
      normText(c.name),
      normText(c.origin),
      normText(c.assignedTo),
      normText(tags),
      normText(c.notes),
      normPhone(c.phone),
    ].join('|');
  }

  function updateSearchKey(id){
    const c = App.byId[id];
    if (!c) return;
    c._k = buildSearchKey(c);
  }

  function setDirty(){
    App.dirty = true;
    scheduleSave();
  }

  function scheduleSave(){
    if (App.saveTimer) return;
    App.saveTimer = setTimeout(() => {
      App.saveTimer = null;
      const doSave = () => {
        if (!App.dirty) return;
        App.dirty = false;
        const payload = {
          version: 1,
          contacts: App.contacts,
          origins: Array.from(App.origins),
          operators: Array.from(App.operators),
          waTemplate: App.waTemplate,
        };
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        }catch(err){
          console.error(err);
          showNotification('‚ö†Ô∏è No se pudo guardar (localStorage lleno). Consider√° exportar / limpiar.', 'warning');
        }
      };
      if ('requestIdleCallback' in window) requestIdleCallback(doSave, {timeout: 1200});
      else setTimeout(doSave, 0);
    }, 550);
  }

  window.addEventListener('beforeunload', () => {
    if (!App.dirty) return;
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        version: 1,
        contacts: App.contacts,
        origins: Array.from(App.origins),
        operators: Array.from(App.operators),
        waTemplate: App.waTemplate,
      }));
    }catch(e){}
  });

  function copyToClipboard(text, label=''){
    navigator.clipboard?.writeText(text ?? '').then(() => {
      showNotification(`Copiado ${label ? '('+label+')' : ''}`, 'success');
    }).catch(() => {
      showNotification('No se pudo copiar', 'error');
    });
  }

  function waLinkForContact(c){
    const phone = normPhone(c.phone);
    if (!phone) return '#';
    const tagsStr = (c.tags||[]).map(t => (tagInfo(t)?.label ?? t)).join(', ');
    const tpl = (App.waTemplate || DEFAULT_WA_TEMPLATE);
    const msg = tpl
      .replaceAll('{name}', c.name ?? '')
      .replaceAll('{origin}', c.origin ?? '')
      .replaceAll('{tags}', tagsStr)
      .replaceAll('{notes}', c.notes ?? '');

    const url = `https://wa.me/+${phone}?text=${encodeURIComponent(msg)}`;
    return url;
  }

  /***********************
   * IMPORTERS (VCF + CSV)
   * - No ‚Äúrompemos‚Äù formatos: aceptamos varios headers.
   ***********************/
  function parseVCF(vcfText, origin){
    const contacts = [];
    const vcards = vcfText.split(/END:VCARD/i).filter(v => v.trim());
    for (let vcard of vcards){
      vcard = vcard.trim();
      if (!vcard.includes('BEGIN:VCARD')) continue;

      const nameMatch = vcard.match(/FN:(.+)/i);
      const telMatch = vcard.match(/TEL[^:]*:(.+)/i);

      if (nameMatch || telMatch){
        const contact = {
          id: Date.now() + Math.random().toString(36).slice(2, 10),
          name: nameMatch ? nameMatch[1].trim() : 'Sin nombre',
          phone: telMatch ? normPhone(telMatch[1]) : '',
          origin: origin,
          status: 'sin revisar',
          tags: [],
          notes: '',
          nextContact: '',
          assignedTo: 'Sin asignar',
          lastUpdated: new Date().toISOString(),
        };
        contact._k = buildSearchKey(contact);
        contacts.push(contact);
      }
    }
    return contacts;
  }

  // CSV parser: soporta comas y punto y coma. Mantiene compatibilidad (no exige un formato √∫nico).
  function parseCSV(csvText, originFallback){
    const lines = csvText.replace(/\r/g,'').split('\n').filter(l => l.trim().length);
    if (!lines.length) return [];

    const sniff = lines[0];
    const sep = sniff.includes(';') && !sniff.includes(',') ? ';' : ','; // heur√≠stica simple
    const splitLine = (line) => {
      // CSV ‚Äúlite‚Äù: respeta comillas dobles.
      const out = [];
      let cur = '';
      let inQ = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){
          if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        }else if (ch === sep && !inQ){
          out.push(cur); cur = '';
        }else{
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(s => s.trim());
    };

    const header = splitLine(lines[0]).map(h => normText(h));
    const hasHeader = header.some(h => ['nombre','name','telefono','tel√©fono','phone','origen','origin','estado','status'].includes(h));

    let col = { name:-1, phone:-1, origin:-1, status:-1, updated:-1, tags:-1, notes:-1, next:-1, assigned:-1 };

    function indexOfAny(arr, options){
      for (const opt of options){
        const idx = arr.indexOf(opt);
        if (idx >= 0) return idx;
      }
      return -1;
    }

    let startIdx = 0;
    if (hasHeader){
      col.name = indexOfAny(header, ['nombre','name','full name','fn']);
      col.phone = indexOfAny(header, ['telefono','tel√©fono','phone','tel','cel','mobile','numero','n√∫mero']);
      col.origin = indexOfAny(header, ['origen','origin','fuente','source']);
      col.status = indexOfAny(header, ['estado','status']);
      col.updated = indexOfAny(header, ['fecha actualizacion','fecha actualizaci√≥n','actualizacion','actualizaci√≥n','updated','lastupdated']);
      col.tags = indexOfAny(header, ['etiquetas','tags','labels']);
      col.notes = indexOfAny(header, ['nota','notas','notes']);
      col.next = indexOfAny(header, ['proximo contacto','pr√≥ximo contacto','nextcontact','next contact']);
      col.assigned = indexOfAny(header, ['asignado a','operador','assigned','assignedto']);
      startIdx = 1;
    }else{
      // Sin header: intentamos [Nombre, Tel√©fono, Origen] m√≠nimo.
      col.name = 0;
      col.phone = 1;
      col.origin = 2;
      col.status = 3;
      col.updated = 4;
    }

    const contacts = [];
    for (let i=startIdx; i<lines.length; i++){
      const row = splitLine(lines[i]);
      if (!row.length) continue;

      const name = (col.name>=0 ? row[col.name] : '') || 'Sin nombre';
      const phone = normPhone(col.phone>=0 ? row[col.phone] : '');
      const origin = (col.origin>=0 ? row[col.origin] : '') || originFallback || '‚Äî';
      const status = (col.status>=0 ? normText(row[col.status]) : '') || 'sin revisar';
      const updatedRaw = (col.updated>=0 ? row[col.updated] : '');
      const updated = updatedRaw ? new Date(updatedRaw).toISOString() : new Date().toISOString();

      const tagsRaw = col.tags>=0 ? row[col.tags] : '';
      const tags = tagsRaw ? tagsRaw.split(/[|,;]/).map(t => normText(t)).filter(Boolean) : [];

      const notes = (col.notes>=0 ? row[col.notes] : '') || '';
      const nextContact = (col.next>=0 ? row[col.next] : '') || '';
      const assignedTo = (col.assigned>=0 ? row[col.assigned] : '') || 'Sin asignar';

      const contact = {
        id: Date.now() + Math.random().toString(36).slice(2, 10),
        name: name.trim(),
        phone,
        origin: origin.trim(),
        status: normalizeStatus(status),
        tags: normalizeTags(tags),
        notes,
        nextContact: normalizeISODate(nextContact),
        assignedTo: assignedTo.trim() || 'Sin asignar',
        lastUpdated: updated,
      };
      contact._k = buildSearchKey(contact);
      contacts.push(contact);
    }

    return contacts;
  }

  function normalizeStatus(s){
    const x = normText(s);
    if (!x) return 'sin revisar';
    // mapeos t√≠picos
    if (x.includes('sin') && x.includes('wsp')) return 'sin wsp';
    if (x.includes('no') && x.includes('inter')) return 'no interesado';
    if (x.includes('contact')) return 'contactado';
    if (x.includes('jug')) return 'jugando';
    if (x.includes('revis')) return 'sin revisar';
    // si es exactamente uno v√°lido
    if (STATUS.some(st => st.id === x)) return x;
    return 'sin revisar';
  }

  function normalizeTags(tags){
    const allowed = new Set(TAGS.map(t=>t.id));
    const out = [];
    for (const t of tags){
      const x = normText(t);
      if (!x) continue;
      // tolerancia a emoji / label
      const mapped =
        x.includes('alta') ? 'alta prioridad' :
        x.includes('poten') ? 'potencial alto' :
        x.includes('recont') ? 'recontactar' :
        x.includes('promo') ? 'promo enviada' :
        x.includes('frio') || x.includes('fr√≠o') ? 'fr√≠o' :
        x;
      if (allowed.has(mapped) && !out.includes(mapped)) out.push(mapped);
    }
    return out;
  }

  function normalizeISODate(s){
    const x = (s||'').toString().trim();
    if (!x) return '';
    // si ya es yyyy-mm-dd
    if (/^\d{4}-\d{2}-\d{2}$/.test(x)) return x;
    // intentar parsear
    const d = new Date(x);
    if (Number.isNaN(d.getTime())) return '';
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  /***********************
   * DEDUP + UPSERT
   ***********************/
  function rebuildIndexes(){
    App.byId = Object.create(null);
    App.byPhone = Object.create(null);
    App.origins = new Set(App.origins); // keep
    App.operators = new Set(App.operators); // keep

    for (const c of App.contacts){
      ensureContactDefaults(c);
      App.byId[c.id] = c;
      const p = normPhone(c.phone);
      if (p) App.byPhone[p] = c.id;
      if (c.origin) App.origins.add(c.origin);
      if (c.assignedTo) App.operators.add(c.assignedTo);
    }
  }

  function statusRank(s){
    // m√°s avanzado = mayor rank (para fusiones)
    const rank = {
      'sin revisar': 0,
      'contactado': 1,
      'jugando': 2,
      'no interesado': 1,
      'sin wsp': 0,
    };
    return rank[s] ?? 0;
  }

  function upsertContacts(newContacts, dedupAction){
    // dedupAction: 'skip' | 'update' | 'merge'
    let added=0, updated=0, skipped=0;
    for (const n of newContacts){
      ensureContactDefaults(n);
      const p = normPhone(n.phone);
      const existingId = p ? App.byPhone[p] : null;

      if (!existingId){
        App.contacts.push(n);
        App.byId[n.id] = n;
        if (p) App.byPhone[p] = n.id;
        if (n.origin) App.origins.add(n.origin);
        if (n.assignedTo) App.operators.add(n.assignedTo);
        added++;
      }else{
        const e = App.byId[existingId];
        if (!e){ // raro
          App.contacts.push(n);
          App.byId[n.id] = n;
          if (p) App.byPhone[p] = n.id;
          added++;
          continue;
        }

        if (dedupAction === 'skip'){
          skipped++;
          continue;
        }

        if (dedupAction === 'update'){
          // actualizar campos ‚Äúsi vienen mejores‚Äù
          if (n.name && n.name !== 'Sin nombre') e.name = n.name;
          if (n.origin) e.origin = n.origin;
          if (n.assignedTo) e.assignedTo = n.assignedTo || e.assignedTo;
          if (n.nextContact) e.nextContact = n.nextContact;
          if (n.notes) e.notes = n.notes;
          if (Array.isArray(n.tags) && n.tags.length) e.tags = normalizeTags([...new Set([...(e.tags||[]), ...n.tags])]);
          // status: si el nuevo es m√°s avanzado, lo subimos
          if (statusRank(n.status) > statusRank(e.status)) e.status = n.status;

          e.lastUpdated = new Date().toISOString();
          updateSearchKey(e.id);
          App.origins.add(e.origin);
          App.operators.add(e.assignedTo);
          updated++;
          continue;
        }

        if (dedupAction === 'merge'){
          // fusionar: tags union + notas append (si no duplican)
          if (n.name && n.name !== 'Sin nombre' && (e.name === 'Sin nombre' || e.name.length < n.name.length)) e.name = n.name;
          if (n.origin && e.origin !== n.origin) e.origin = n.origin; // preferimos √∫ltimo origen
          if (n.assignedTo && e.assignedTo === 'Sin asignar') e.assignedTo = n.assignedTo;

          const mergedTags = normalizeTags([...new Set([...(e.tags||[]), ...(n.tags||[])])]);
          e.tags = mergedTags;

          if (n.nextContact) e.nextContact = n.nextContact;

          if (n.notes){
            const a = (e.notes||'').trim();
            const b = (n.notes||'').trim();
            if (!a) e.notes = b;
            else if (b && !a.includes(b)) e.notes = a + ' | ' + b;
          }

          if (statusRank(n.status) > statusRank(e.status)) e.status = n.status;

          e.lastUpdated = new Date().toISOString();
          updateSearchKey(e.id);
          App.origins.add(e.origin);
          App.operators.add(e.assignedTo);
          updated++;
          continue;
        }
      }
    }
    setDirty();
    return {added, updated, skipped};
  }

  /***********************
   * FILTERING + STATS
   ***********************/
  function applyFilters(){
    const statusFilter = App.currentFilterStatus;
    const q = normText(App.searchQuery);
    const originF = App.originFilter;
    const tagF = App.tagFilter;
    const opF = App.operatorFilter;
    const dueToday = App.dueTodayOnly;
    const dueInDays = Number(App.dueInDays || 0);

    const today = todayISO();

    const ids = [];
    for (const c of App.contacts){
      if (statusFilter !== 'all' && c.status !== statusFilter) continue;
      if (originF !== 'all' && c.origin !== originF) continue;
      if (opF !== 'all' && c.assignedTo !== opF) continue;
      if (tagF !== 'all' && !(c.tags||[]).includes(tagF)) continue;

      if (dueToday){
        if (!c.nextContact || c.nextContact !== today) continue;
      }else if (dueInDays > 0){
        if (!c.nextContact) continue;
        const d = daysBetweenISO(today, c.nextContact);
        if (d === null || d < 0 || d > dueInDays) continue;
      }

      if (q){
        if (!c._k || !c._k.includes(q)) continue;
      }

      ids.push(c.id);
    }

    App.filteredIds = ids;
    App.currentPage = 1;
    App.tinderIndex = 0;
  }

  function computeGlobalStats(){
    let total = App.contacts.length;
    let unrev=0, cont=0, jug=0, noint=0, nowsp=0;
    let dueToday = 0;
    const today = todayISO();

    for (const c of App.contacts){
      if (c.status === 'sin revisar') unrev++;
      else if (c.status === 'contactado') cont++;
      else if (c.status === 'jugando') jug++;
      else if (c.status === 'no interesado') noint++;
      else if (c.status === 'sin wsp') nowsp++;

      if (c.nextContact && c.nextContact === today) dueToday++;
    }

    // top counters
    el.totalContacts.textContent = total.toLocaleString();
    el.unreviewedContacts.textContent = unrev.toLocaleString();
    el.contactedContacts.textContent = cont.toLocaleString();
    el.playingContacts.textContent = jug.toLocaleString();
    el.notInterestedContacts.textContent = noint.toLocaleString();
    el.noWhatsappContacts.textContent = nowsp.toLocaleString();

    // progress
    const reviewed = total - unrev;
    const pct = total ? Math.round((reviewed/total)*100) : 0;
    el.progressPercentage.textContent = pct + '%';
    el.progressFill.style.width = pct + '%';
    el.reviewedCount.textContent = `${reviewed.toLocaleString()} revisados`;
    el.totalCount.textContent = `${total.toLocaleString()} totales`;
    el.dueTodayCount.textContent = `${dueToday.toLocaleString()} vencen hoy`;

    // KPIs
    const conv1 = cont ? (jug/cont) : 0;
    const conv2 = total ? (jug/total) : 0;
    const conv3 = total ? (cont/total) : 0;
    el.kpiConv1.textContent = Math.round(conv1*100) + '%';
    el.kpiConv1Sub.textContent = `${jug.toLocaleString()} / ${cont.toLocaleString()}`;
    el.kpiConv2.textContent = Math.round(conv2*100) + '%';
    el.kpiConv2Sub.textContent = `${jug.toLocaleString()} / ${total.toLocaleString()}`;
    el.kpiConv3.textContent = Math.round(conv3*100) + '%';
    el.kpiConv3Sub.textContent = `${cont.toLocaleString()} / ${total.toLocaleString()}`;
    el.kpiDueToday.textContent = dueToday.toLocaleString();

    // By origin / operator quick stats
    el.statsByOrigin.innerHTML = buildQualityTable('origin');
    el.statsByOperator.innerHTML = buildQualityTable('operator');
  }

  function buildQualityTable(mode){
    // show top 8 by count
    const map = new Map();
    for (const c of App.contacts){
      const key = mode === 'origin' ? (c.origin || '‚Äî') : (c.assignedTo || 'Sin asignar');
      if (!map.has(key)){
        map.set(key, { total:0, jugando:0, contactado:0, sinrevisar:0 });
      }
      const s = map.get(key);
      s.total++;
      if (c.status === 'jugando') s.jugando++;
      if (c.status === 'contactado') s.contactado++;
      if (c.status === 'sin revisar') s.sinrevisar++;
    }

    const rows = Array.from(map.entries()).map(([k,v]) => {
      const conv = v.contactado ? (v.jugando / v.contactado) : 0;
      const quality = v.total ? (v.jugando / v.total) : 0;
      return { k, ...v, conv, quality };
    }).sort((a,b) => b.total - a.total).slice(0, 10);

    if (!rows.length) return '<span class="muted">‚Äî</span>';

    const lines = rows.map(r => {
      const convPct = Math.round(r.conv*100);
      const qPct = Math.round(r.quality*100);
      return `<div style="display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08)">
        <div style="min-width:0">
          <b style="color:var(--text-primary)">${escapeHtml(r.k)}</b>
          <div class="muted" style="font-size:.86rem">Total: ${r.total.toLocaleString()} ‚Ä¢ Sin revisar: ${r.sinrevisar.toLocaleString()}</div>
        </div>
        <div style="text-align:right">
          <div><b style="color:var(--accent-jugando)">${r.jugando.toLocaleString()}</b> jugando</div>
          <div class="muted" style="font-size:.86rem">${convPct}% (Jug/Cont) ‚Ä¢ ${qPct}% (Jug/Total)</div>
        </div>
      </div>`;
    }).join('');

    return lines;
  }

  function refreshFiltersUI(){
    // origins dropdown
    const origins = Array.from(App.origins).sort((a,b)=>a.localeCompare(b,'es'));
    el.originFilter.innerHTML = `<option value="all">Origen: Todos</option>` + origins.map(o =>
      `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`
    ).join('');

    // operator dropdowns
    const ops = Array.from(App.operators).sort((a,b)=>a.localeCompare(b,'es'));
    el.operatorFilter.innerHTML = `<option value="all">Operador: Todos</option>` + ops.map(o =>
      `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`
    ).join('');

    el.tinderOperator.innerHTML = ops.map(o =>
      `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`
    ).join('');
  }

  /***********************
   * RENDER (PAGED)
   ***********************/
  function render(){
    computeGlobalStats();
    applyFilters();
    renderView();
    renderPagination();
    renderTinder();
  }

  function renderView(){
    el.cardsView.classList.toggle('active', App.currentView === 'cards');
    el.listView.classList.toggle('active', App.currentView === 'list');
    el.tinderView.classList.toggle('active', App.currentView === 'tinder');

    if (App.currentView === 'cards') renderCardsPage();
    if (App.currentView === 'list') renderListPage();
  }

  function getPageSize(){
    return App.currentView === 'list' ? App.pageSizeList : App.pageSizeCards;
  }

  function getPagedIds(){
    const size = getPageSize();
    const total = App.filteredIds.length;
    const pages = Math.max(1, Math.ceil(total / size));
    if (App.currentPage > pages) App.currentPage = pages;

    const start = (App.currentPage - 1) * size;
    return App.filteredIds.slice(start, start + size);
  }

  function renderCardsPage(){
    const ids = getPagedIds();
    const frag = document.createDocumentFragment();

    for (const id of ids){
      const c = App.byId[id];
      if (!c) continue;

      const card = document.createElement('div');
      card.className = 'contact-card';
      card.dataset.id = c.id;
      card.dataset.status = c.status;

      const statusLabel = pickStatusLabel(c.status);
      const dot = statusDotClass(c.status);

      const tagsHtml = (c.tags && c.tags.length) ? c.tags.map(t => {
        const info = tagInfo(t);
        const dotCls = info?.cls ?? 't-cold';
        const label = info?.label ?? t;
        return `<span class="tag"><span class="t-dot ${dotCls}"></span>${escapeHtml(label)}</span>`;
      }).join('') : `<span class="tag tag-empty"><span class="t-dot t-cold"></span>Sin etiquetas</span>`;

      const nextContactBadge = c.nextContact ? ` ‚Ä¢ Pr√≥x: <b>${escapeHtml(c.nextContact)}</b>` : '';
      const assignedBadge = c.assignedTo && c.assignedTo !== 'Sin asignar' ? ` ‚Ä¢ <i class="fa-solid fa-user"></i> ${escapeHtml(c.assignedTo)}` : '';

      card.innerHTML = `
        <div class="badge-status">
          <span class="badge-dot ${dot}"></span>
          ${escapeHtml(statusLabel).toUpperCase()}
        </div>

        <div class="contact-header">
          <div class="contact-name" data-action="copyName">${escapeHtml(c.name)}</div>
          <div class="pill">${escapeHtml(c.origin)}</div>
        </div>

        <div class="contact-info">
          <div class="contact-phone">${escapeHtml(c.phone ? ('+'+c.phone) : 'Sin n√∫mero')}</div>
          ${c.phone ? `<a class="whatsapp-btn" target="_blank" data-action="openWA" href="${waLinkForContact(c)}">
            <i class="fab fa-whatsapp"></i> Enviar WhatsApp
          </a>` : `<span class="muted">Sin WhatsApp disponible</span>`}
        </div>

        <div class="tags">${tagsHtml}</div>

        <div class="meta-grid">
          <div class="meta-field">
            <label>Estado</label>
            <select class="status-select" data-action="status">
              ${STATUS.map(s => `<option value="${s.id}" ${s.id===c.status?'selected':''}>${s.label}</option>`).join('')}
            </select>
          </div>

          <div class="meta-field">
            <label>Pr√≥ximo contacto</label>
            <input type="date" data-action="nextContact" value="${escapeHtml(c.nextContact||'')}"/>
          </div>

          <div class="meta-field">
            <label>Asignado a</label>
            <select data-action="assignedTo">
              ${Array.from(App.operators).sort((a,b)=>a.localeCompare(b,'es')).map(o =>
                `<option value="${escapeHtml(o)}" ${o===c.assignedTo?'selected':''}>${escapeHtml(o)}</option>`
              ).join('')}
            </select>
          </div>

          <div class="meta-field">
            <label>Agregar etiqueta</label>
            <select data-action="addTag">
              <option value="">+ Elegir‚Ä¶</option>
              ${TAGS.map(t => `<option value="${t.id}">${t.label}</option>`).join('')}
            </select>
          </div>
        </div>

        <div class="notes">
          <label>Notas r√°pidas</label>
          <textarea data-action="notes" placeholder="Ej: Pidi√≥ bono 50% / Carga el viernes / No le anda MP...">${escapeHtml(c.notes||'')}</textarea>
        </div>

        <div class="actions">
          <button class="small-btn btn-outline-danger" data-action="delete"><i class="fas fa-trash"></i> Borrar</button>
          <span class="muted" style="font-size:.85rem"><i class="far fa-clock"></i> ${new Date(c.lastUpdated).toLocaleString('es-AR')}${nextContactBadge}${assignedBadge}</span>
        </div>
      `;

      frag.appendChild(card);
    }

    el.cardsView.replaceChildren(frag);
  }

  function renderListPage(){
    const ids = getPagedIds();
    const frag = document.createDocumentFragment();

    for (const id of ids){
      const c = App.byId[id];
      if (!c) continue;

      const item = document.createElement('div');
      item.className = 'list-item';
      item.dataset.id = c.id;
      item.dataset.status = c.status;

      const tagsShort = (c.tags||[]).slice(0,2).map(t => tagInfo(t)?.label ?? t).join(' ‚Ä¢ ');
      const tagsMore = (c.tags||[]).length > 2 ? ` (+${(c.tags||[]).length-2})` : '';
      const due = c.nextContact ? `Pr√≥x: ${c.nextContact}` : 'Pr√≥x: ‚Äî';
      const asg = c.assignedTo && c.assignedTo !== 'Sin asignar' ? `Oper: ${c.assignedTo}` : 'Oper: ‚Äî';

      item.innerHTML = `
        <div class="list-left">
          <div class="list-name" data-action="copyName">${escapeHtml(c.name)}</div>
          <div class="list-details">
            <span><i class="fa-solid fa-phone"></i> ${escapeHtml(c.phone ? ('+'+c.phone) : 'Sin n√∫mero')}</span>
            <span class="pill">${escapeHtml(c.origin)}</span>
            <span class="muted">${escapeHtml(due)}</span>
            <span class="muted">${escapeHtml(asg)}</span>
            <span class="muted">${escapeHtml(tagsShort)}${escapeHtml(tagsMore)}</span>
          </div>
          ${c.notes ? `<div class="muted" style="margin-top:6px;font-size:.9rem;line-height:1.25"><i class="fa-regular fa-note-sticky"></i> ${escapeHtml(c.notes)}</div>` : ''}
        </div>

        <div class="list-right">
          ${c.phone ? `<a class="whatsapp-btn" target="_blank" data-action="openWA" href="${waLinkForContact(c)}">
            <i class="fab fa-whatsapp"></i> WhatsApp
          </a>` : ''}

          <select class="select" data-action="status">
            ${STATUS.map(s => `<option value="${s.id}" ${s.id===c.status?'selected':''}>${s.label}</option>`).join('')}
          </select>

          <input class="date" type="date" data-action="nextContact" value="${escapeHtml(c.nextContact||'')}"/>

          <select class="select" data-action="assignedTo">
            ${Array.from(App.operators).sort((a,b)=>a.localeCompare(b,'es')).map(o =>
              `<option value="${escapeHtml(o)}" ${o===c.assignedTo?'selected':''}>${escapeHtml(o)}</option>`
            ).join('')}
          </select>

          <select class="select" data-action="addTag">
            <option value="">+ Tag</option>
            ${TAGS.map(t => `<option value="${t.id}">${t.label}</option>`).join('')}
          </select>

          <button class="mini" data-action="delete" title="Borrar"><i class="fa-solid fa-trash"></i></button>
        </div>
      `;

      frag.appendChild(item);
    }

    el.listView.replaceChildren(frag);
  }

  function renderPagination(){
    if (App.currentView === 'tinder'){
      el.pagination.innerHTML = '';
      return;
    }
    const total = App.filteredIds.length;
    const size = getPageSize();
    const pages = Math.max(1, Math.ceil(total / size));
    const cur = App.currentPage;

    const frag = document.createDocumentFragment();

    const mkBtn = (label, page, disabled=false, active=false) => {
      const b = document.createElement('button');
      b.className = 'page-btn' + (active ? ' active' : '');
      b.textContent = label;
      b.disabled = disabled;
      b.addEventListener('click', () => {
        App.currentPage = page;
        renderView();
        renderPagination();
        window.scrollTo({top:0, behavior:'smooth'});
      });
      return b;
    };

    frag.appendChild(mkBtn('¬´', 1, cur===1));
    frag.appendChild(mkBtn('‚Äπ', Math.max(1, cur-1), cur===1));

    // window pages
    const windowSize = 7;
    const start = Math.max(1, cur - Math.floor(windowSize/2));
    const end = Math.min(pages, start + windowSize - 1);
    const start2 = Math.max(1, end - windowSize + 1);

    for (let p=start2; p<=end; p++){
      frag.appendChild(mkBtn(String(p), p, false, p===cur));
    }

    frag.appendChild(mkBtn('‚Ä∫', Math.min(pages, cur+1), cur===pages));
    frag.appendChild(mkBtn('¬ª', pages, cur===pages));

    el.pagination.replaceChildren(frag);
  }

  /***********************
   * TINDER
   ***********************/
  function renderTinder(){
    if (App.currentView !== 'tinder') return;

    const ids = App.filteredIds;
    const total = ids.length;

    if (!total){
      el.tinderCounter.textContent = `0 / 0`;
      el.tinderName.textContent = 'No hay contactos en este filtro';
      el.tinderOrigin.textContent = '‚Äî';
      el.tinderPhone.textContent = '‚Äî';
      el.tinderWhatsapp.href = '#';
      el.tinderCard.dataset.status = 'sin revisar';
      el.tinderTags.innerHTML = '';
      el.tinderNotes.value = '';
      el.tinderNextContact.value = '';
      el.tinderOperator.value = 'Sin asignar';
      return;
    }

    if (App.tinderIndex < 0) App.tinderIndex = 0;
    if (App.tinderIndex >= total) App.tinderIndex = total - 1;

    const id = ids[App.tinderIndex];
    const c = App.byId[id];
    if (!c) return;

    el.tinderCounter.textContent = `${App.tinderIndex + 1} / ${total}`;
    el.tinderName.textContent = c.name;
    el.tinderOrigin.textContent = c.origin;
    el.tinderPhone.textContent = c.phone ? ('+' + c.phone) : 'Sin n√∫mero';
    el.tinderWhatsapp.href = waLinkForContact(c);
    el.tinderCard.dataset.status = c.status;

    el.tinderNextContact.value = c.nextContact || '';
    // operator select already filled; set
    el.tinderOperator.value = c.assignedTo || 'Sin asignar';

    // tags
    el.tinderTags.innerHTML = '';
    if (c.tags && c.tags.length){
      for (const t of c.tags){
        const info = tagInfo(t);
        const span = document.createElement('span');
        span.className = 'tag';
        span.innerHTML = `<span class="t-dot ${info?.cls ?? 't-cold'}"></span>${escapeHtml(info?.label ?? t)} <i class="fa-solid fa-xmark" style="margin-left:6px;cursor:pointer" data-action="removeTag" data-tag="${escapeHtml(t)}"></i>`;
        el.tinderTags.appendChild(span);
      }
    }else{
      const span = document.createElement('span');
      span.className = 'tag tag-empty';
      span.innerHTML = `<span class="t-dot t-cold"></span>Sin etiquetas`;
      el.tinderTags.appendChild(span);
    }

    el.tinderNotes.value = c.notes || '';
    el.tinderTagQuick.value = '';
  }

  function tinderNext(){
    if (!App.filteredIds.length) return;
    App.tinderIndex = Math.min(App.filteredIds.length-1, App.tinderIndex + 1);
    renderTinder();
  }

  function tinderBack(){
    if (!App.filteredIds.length) return;
    App.tinderIndex = Math.max(0, App.tinderIndex - 1);
    renderTinder();
  }

  function setStatusAndAdvance(newStatus){
    if (!App.filteredIds.length) return;
    const id = App.filteredIds[App.tinderIndex];
    updateStatus(id, newStatus);
    // avanzar autom√°ticamente
    setTimeout(() => tinderNext(), 120);
  }

  /***********************
   * MUTATIONS
   ***********************/
  function updateStatus(id, status){
    const c = App.byId[id];
    if (!c) return;
    c.status = status;
    c.lastUpdated = new Date().toISOString();
    updateSearchKey(id);
    setDirty();

    // re-render lightweight
    computeGlobalStats();
    applyFilters();
    renderView();
    renderPagination();
    renderTinder();
  }

  function updateNextContact(id, nextISO){
    const c = App.byId[id];
    if (!c) return;
    c.nextContact = normalizeISODate(nextISO);
    c.lastUpdated = new Date().toISOString();
    updateSearchKey(id);
    setDirty();

    computeGlobalStats();
    applyFilters();
    renderView();
    renderPagination();
    renderTinder();
  }

  function updateAssignedTo(id, operator){
    const c = App.byId[id];
    if (!c) return;
    const op = operator?.trim() || 'Sin asignar';
    c.assignedTo = op;
    App.operators.add(op);
    c.lastUpdated = new Date().toISOString();
    updateSearchKey(id);
    setDirty();

    refreshFiltersUI();
    computeGlobalStats();
    applyFilters();
    renderView();
    renderPagination();
    renderTinder();
  }

  function addTag(id, tagId){
    if (!tagId) return;
    const c = App.byId[id];
    if (!c) return;
    c.tags = c.tags || [];
    if (!c.tags.includes(tagId)) c.tags.push(tagId);
    c.tags = normalizeTags(c.tags);
    c.lastUpdated = new Date().toISOString();
    updateSearchKey(id);
    setDirty();

    computeGlobalStats();
    applyFilters();
    renderView();
    renderPagination();
    renderTinder();
  }

  function removeTag(id, tagId){
    const c = App.byId[id];
    if (!c) return;
    c.tags = (c.tags||[]).filter(t => t !== tagId);
    c.lastUpdated = new Date().toISOString();
    updateSearchKey(id);
    setDirty();

    computeGlobalStats();
    applyFilters();
    renderView();
    renderPagination();
    renderTinder();
  }

  function updateNotes(id, notes){
    const c = App.byId[id];
    if (!c) return;
    c.notes = notes || '';
    c.lastUpdated = new Date().toISOString();
    updateSearchKey(id);
    setDirty();
  }

  function deleteContact(id){
    const c = App.byId[id];
    if (!c) return;
    const p = normPhone(c.phone);
    if (p && App.byPhone[p] === id) delete App.byPhone[p];

    delete App.byId[id];
    App.contacts = App.contacts.filter(x => x.id !== id);

    setDirty();
    showNotification('Contacto borrado', 'success');

    computeGlobalStats();
    applyFilters();
    renderView();
    renderPagination();
    renderTinder();
  }

  function clearAll(){
    if (!confirm('¬øSeguro que quer√©s borrar TODO? (Se pierde lo guardado en este navegador)')) return;
    App.contacts = [];
    App.byId = Object.create(null);
    App.byPhone = Object.create(null);
    App.origins = new Set();
    App.operators = new Set(DEFAULT_OPERATORS);

    App.currentFilterStatus = 'all';
    App.searchQuery = '';
    App.originFilter = 'all';
    App.tagFilter = 'all';
    App.operatorFilter = 'all';
    App.dueTodayOnly = false;
    App.dueInDays = 0;

    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
    showNotification('Datos borrados', 'success');

    // show upload again
    showUploadScreen();
  }

  /***********************
   * EXPORT
   ***********************/
  function showExportModal(){
    const total = App.contacts.length;
    const unreviewed = App.contacts.filter(c => c.status === 'sin revisar').length;
    let warning = `Vas a exportar ${total.toLocaleString()} contacto(s).`;
    if (unreviewed > 0){
      warning += `\n\n‚ö†Ô∏è Hay ${unreviewed.toLocaleString()} contacto(s) sin revisar.`;
    }
    el.exportWarning.textContent = warning;
    el.exportModal.classList.add('active');
  }
  function hideExportModal(){ el.exportModal.classList.remove('active'); }

  function exportContacts(){
    const format = document.querySelector('input[name="exportFormat"]:checked')?.value || 'csv';
    const scope = document.querySelector('input[name="exportScope"]:checked')?.value || 'all';

    let ids = [];
    const today = todayISO();

    if (scope === 'all'){
      ids = App.contacts.map(c => c.id);
    } else if (scope === 'current'){
      ids = App.filteredIds.slice();
    } else if (scope === 'dueToday'){
      ids = App.contacts.filter(c => c.nextContact === today).map(c => c.id);
    } else if (scope === 'status'){
      const st = el.exportStatusPick.value;
      ids = App.contacts.filter(c => c.status === st).map(c => c.id);
    }

    const items = ids.map(id => App.byId[id]).filter(Boolean);

    if (!items.length){
      showNotification('No hay contactos para exportar con ese filtro', 'warning');
      hideExportModal();
      return;
    }

    if (format === 'csv') exportToCSV(items);
    else exportToVCF(items);

    hideExportModal();
  }

  function exportToCSV(items){
    // CSV PRO: mantiene columnas originales + agrega extras al final (no rompe lo viejo)
    let csv = "Nombre,Tel√©fono,Origen,Estado,Fecha Actualizaci√≥n,Etiquetas,Notas,Pr√≥ximo contacto,Asignado a\n";
    for (const c of items){
      const row = [
        `"${(c.name||'').replace(/"/g,'""')}"`,
        c.phone || '',
        `"${(c.origin||'').replace(/"/g,'""')}"`,
        c.status || 'sin revisar',
        (c.lastUpdated ? new Date(c.lastUpdated).toLocaleString('es-AR') : ''),
        `"${(c.tags||[]).join('|').replace(/"/g,'""')}"`,
        `"${(c.notes||'').replace(/"/g,'""')}"`,
        c.nextContact || '',
        `"${(c.assignedTo||'Sin asignar').replace(/"/g,'""')}"`,
      ];
      csv += row.join(',') + "\n";
    }
    downloadBlob(csv, `nexo_smoky_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
    showNotification('Exportaci√≥n CSV completada', 'success');
  }

  function exportToVCF(items){
    let vcf = '';
    for (const c of items){
      vcf += `BEGIN:VCARD\nVERSION:3.0\n`;
      vcf += `FN:${(c.name||'').replace(/\n/g,' ')}\n`;
      if (c.phone) vcf += `TEL;TYPE=CELL:${c.phone}\n`;
      const tagsStr = (c.tags||[]).join('|');
      const note = (c.notes||'').replace(/\n/g,' ');
      const next = c.nextContact || '';
      const asg = c.assignedTo || 'Sin asignar';
      vcf += `NOTE:Origen:${c.origin||''} | Estado:${c.status||''} | Tags:${tagsStr} | Next:${next} | Asignado:${asg} | Notas:${note}\n`;
      vcf += `END:VCARD\n\n`;
    }
    downloadBlob(vcf, `nexo_smoky_${new Date().toISOString().split('T')[0]}.vcf`, 'text/vcard;charset=utf-8');
    showNotification('Exportaci√≥n VCF completada', 'success');
  }

  function downloadBlob(content, filename, mime){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.visibility = 'hidden';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /***********************
   * UPLOAD SCREEN
   ***********************/
  function showUploadScreen(){
    el.uploadScreen.style.display = 'flex';
    el.mainInterface.style.display = 'none';
    el.uploadScreen.classList.remove('hidden');
    el.fileList.innerHTML = '';
    el.originName.value = '';
    pendingFiles = [];
  }

  function hideUploadScreen(){
    el.uploadScreen.classList.add('hidden');
    setTimeout(() => {
      el.uploadScreen.style.display = 'none';
      el.mainInterface.style.display = 'block';
    }, 280);
  }

  let pendingFiles = [];
  let pendingParsedContacts = [];
  let pendingDedupCounts = { duplicates: 0, total: 0 };

  function addFilesToList(files){
    for (const f of files){
      pendingFiles.push(f);
      const div = document.createElement('div');
      div.className = 'file-item';
      div.innerHTML = `<span>${escapeHtml(f.name)}</span><span style="color:var(--accent-primary)">${(f.size/1024).toFixed(1)} KB</span>`;
      el.fileList.appendChild(div);
    }
    el.fileInput.value = '';
  }

  async function processFiles(){
    if (!pendingFiles.length){
      showNotification('Seleccion√° al menos un archivo VCF o CSV', 'warning');
      return;
    }
    const origin = el.originName.value.trim();
    if (!origin){
      showNotification('Ingres√° un nombre de origen (ej: Pc05)', 'warning');
      return;
    }

    el.processFiles.disabled = true;
    el.processFiles.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

    try{
      pendingParsedContacts = [];
      pendingDedupCounts = {duplicates:0,total:0};

      for (const f of pendingFiles){
        const txt = await f.text();
        let parsed = [];
        const lower = f.name.toLowerCase();
        if (lower.endsWith('.vcf') || lower.endsWith('.vcard')){
          parsed = parseVCF(txt, origin);
        } else if (lower.endsWith('.csv')){
          parsed = parseCSV(txt, origin);
        } else {
          continue;
        }

        pendingDedupCounts.total += parsed.length;

        // contar duplicados (por phone)
        for (const c of parsed){
          const p = normPhone(c.phone);
          if (p && App.byPhone[p]) pendingDedupCounts.duplicates++;
        }

        pendingParsedContacts.push(...parsed);
      }

      App.origins.add(origin);

      // si hay duplicados, preguntamos acci√≥n
      if (pendingDedupCounts.duplicates > 0){
        el.dedupInfo.textContent =
          `Se detectaron ${pendingDedupCounts.duplicates.toLocaleString()} repetidos (por n√∫mero) sobre ${pendingDedupCounts.total.toLocaleString()} importados.\nEleg√≠ qu√© hacer:`;
        el.dedupModal.classList.add('active');
      } else {
        // sin duplicados -> insertar directo
        const res = upsertContacts(pendingParsedContacts, 'skip');
        showNotification(`Importados: +${res.added.toLocaleString()} (sin duplicados)`, 'success');
        pendingFiles = [];
        pendingParsedContacts = [];
        hideUploadScreen();
        refreshFiltersUI();
        render();
      }
    }catch(err){
      console.error(err);
      showNotification('Error al procesar: ' + err.message, 'error');
    }finally{
      el.processFiles.disabled = false;
      el.processFiles.innerHTML = '<i class="fas fa-play"></i> Procesar Archivos y Comenzar';
    }
  }

  function applyDedupAndFinish(){
    const action = document.querySelector('input[name="dedupAction"]:checked')?.value || 'skip';
    const res = upsertContacts(pendingParsedContacts, action);
    el.dedupModal.classList.remove('active');

    showNotification(`Listo ‚úÖ  +${res.added.toLocaleString()} ‚Ä¢ actualizados ${res.updated.toLocaleString()} ‚Ä¢ omitidos ${res.skipped.toLocaleString()}`, 'success');

    pendingFiles = [];
    pendingParsedContacts = [];
    hideUploadScreen();
    refreshFiltersUI();
    render();
  }

  /***********************
   * EVENTS (FAST)
   ***********************/
  // Event delegation (cards + list)
  function onContainerClick(e){
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;
    const root = btn.closest('[data-id]');
    const id = root?.dataset.id;
    if (!id) return;
    const c = App.byId[id];
    if (!c) return;

    if (action === 'delete'){
      deleteContact(id);
      return;
    }
    if (action === 'copyName'){
      copyToClipboard(c.name, 'nombre');
      return;
    }
    if (action === 'openWA'){
      // href already has template
      return;
    }
  }

  function onContainerChange(e){
    const root = e.target.closest('[data-id]');
    if (!root) return;
    const id = root.dataset.id;
    const c = App.byId[id];
    if (!c) return;

    const action = e.target.dataset.action;
    if (!action) return;

    if (action === 'status'){
      updateStatus(id, e.target.value);
      return;
    }
    if (action === 'nextContact'){
      updateNextContact(id, e.target.value);
      return;
    }
    if (action === 'assignedTo'){
      updateAssignedTo(id, e.target.value);
      return;
    }
    if (action === 'addTag'){
      addTag(id, e.target.value);
      e.target.value = '';
      return;
    }
  }

  function onContainerInput(e){
    const root = e.target.closest('[data-id]');
    if (!root) return;
    const id = root.dataset.id;
    const c = App.byId[id];
    if (!c) return;

    const action = e.target.dataset.action;
    if (action === 'notes'){
      updateNotes(id, e.target.value);
    }
  }

  el.cardsView.addEventListener('click', onContainerClick);
  el.cardsView.addEventListener('change', onContainerChange);
  el.cardsView.addEventListener('input', onContainerInput);

  el.listView.addEventListener('click', onContainerClick);
  el.listView.addEventListener('change', onContainerChange);

  // Tinder buttons via delegation
  el.tinderView.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) {
      const x = e.target.closest('[data-action="removeTag"]');
      if (x){
        const tag = x.dataset.tag;
        const id = App.filteredIds[App.tinderIndex];
        removeTag(id, tag);
      }
      return;
    }

    const action = btn.dataset.action;
    if (action === 'next') return tinderNext();
    if (action === 'setStatus'){
      const st = btn.dataset.status;
      return setStatusAndAdvance(st);
    }
  });

  // Tinder meta bindings
  el.tinderName.addEventListener('click', () => {
    if (!App.filteredIds.length) return;
    const c = App.byId[App.filteredIds[App.tinderIndex]];
    if (!c) return;
    copyToClipboard(c.name, 'nombre');
  });

  el.tinderNextContact.addEventListener('change', () => {
    if (!App.filteredIds.length) return;
    const id = App.filteredIds[App.tinderIndex];
    updateNextContact(id, el.tinderNextContact.value);
  });

  el.tinderOperator.addEventListener('change', () => {
    if (!App.filteredIds.length) return;
    const id = App.filteredIds[App.tinderIndex];
    updateAssignedTo(id, el.tinderOperator.value);
  });

  el.tinderTagQuick.addEventListener('change', () => {
    if (!App.filteredIds.length) return;
    const id = App.filteredIds[App.tinderIndex];
    addTag(id, el.tinderTagQuick.value);
    el.tinderTagQuick.value = '';
  });

  // notes: debounce save; we already throttle localStorage; here update on input but not rerender
  el.tinderNotes.addEventListener('input', () => {
    if (!App.filteredIds.length) return;
    const id = App.filteredIds[App.tinderIndex];
    updateNotes(id, el.tinderNotes.value);
  });

  // Keyboard shortcuts in Tinder
  window.addEventListener('keydown', (e) => {
    if (App.currentView !== 'tinder') return;

    // if typing in input/textarea, ignore arrows & space
    const tag = (document.activeElement?.tagName || '').toLowerCase();
    if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

    if (e.key === 'ArrowLeft'){ e.preventDefault(); setStatusAndAdvance('no interesado'); }
    else if (e.key === 'ArrowRight'){ e.preventDefault(); setStatusAndAdvance('jugando'); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); setStatusAndAdvance('contactado'); }
    else if (e.key === 'ArrowDown'){ e.preventDefault(); setStatusAndAdvance('sin wsp'); }
    else if (e.key === ' '){ e.preventDefault(); tinderNext(); }
  });

  // View buttons
  el.viewButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      el.viewButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      App.currentView = btn.dataset.view;
      App.currentPage = 1;
      App.tinderIndex = 0;
      renderView();
      renderPagination();
      renderTinder();
    });
  });

  // Status filter boxes
  el.statBoxes.forEach(box => {
    box.addEventListener('click', () => {
      el.statBoxes.forEach(b => b.classList.remove('active'));
      box.classList.add('active');
      App.currentFilterStatus = box.dataset.filter;
      render();
    });
  });

  // Filters + search (debounced)
  let searchTimer = null;
  el.searchInput.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      App.searchQuery = normText(el.searchInput.value);
      render();
    }, 180);
  });

  el.originFilter.addEventListener('change', () => { App.originFilter = el.originFilter.value; render(); });
  el.tagFilter.addEventListener('change', () => { App.tagFilter = el.tagFilter.value; render(); });
  el.operatorFilter.addEventListener('change', () => { App.operatorFilter = el.operatorFilter.value; render(); });
  el.dueTodayOnly.addEventListener('change', () => { App.dueTodayOnly = el.dueTodayOnly.checked; render(); });
  el.dueInDays.addEventListener('change', () => { App.dueInDays = Number(el.dueInDays.value||0); render(); });

  // Export
  el.exportBtn.addEventListener('click', showExportModal);
  el.cancelExport.addEventListener('click', hideExportModal);
  el.confirmExport.addEventListener('click', exportContacts);

  // Clear / Add
  el.clearDataBtn.addEventListener('click', clearAll);
  el.addMoreBtn.addEventListener('click', showUploadScreen);

  // Settings
  el.saveSettingsBtn.addEventListener('click', () => {
    App.waTemplate = el.waTemplate.value || DEFAULT_WA_TEMPLATE;
    setDirty();
    showNotification('Plantilla guardada', 'success');
    // refrescar links visibles
    if (App.currentView !== 'tinder') renderView();
    renderTinder();
  });

  el.resetTemplateBtn.addEventListener('click', () => {
    el.waTemplate.value = DEFAULT_WA_TEMPLATE;
    App.waTemplate = DEFAULT_WA_TEMPLATE;
    setDirty();
    showNotification('Plantilla reseteada', 'success');
    if (App.currentView !== 'tinder') renderView();
    renderTinder();
  });

  // Upload interactions
  el.dropArea.addEventListener('click', () => el.fileInput.click());
  el.fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files).filter(f => {
      const n = f.name.toLowerCase();
      return n.endsWith('.vcf') || n.endsWith('.vcard') || n.endsWith('.csv');
    });
    if (files.length) addFilesToList(files);
  });

  el.dropArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    el.dropArea.style.borderColor = 'var(--accent-primary)';
    el.dropArea.style.background = 'rgba(59, 130, 246, 0.1)';
  });
  el.dropArea.addEventListener('dragleave', () => {
    el.dropArea.style.borderColor = 'var(--border-color)';
    el.dropArea.style.background = 'transparent';
  });
  el.dropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    el.dropArea.style.borderColor = 'var(--border-color)';
    el.dropArea.style.background = 'transparent';
    const files = Array.from(e.dataTransfer.files).filter(f => {
      const n = f.name.toLowerCase();
      return n.endsWith('.vcf') || n.endsWith('.vcard') || n.endsWith('.csv');
    });
    if (files.length) addFilesToList(files);
  });

  el.processFiles.addEventListener('click', processFiles);

  // Dedup modal
  el.dedupCancel.addEventListener('click', () => {
    el.dedupModal.classList.remove('active');
    showNotification('Carga cancelada', 'warning');
    pendingFiles = [];
    pendingParsedContacts = [];
    el.fileList.innerHTML = '';
  });
  el.dedupApply.addEventListener('click', applyDedupAndFinish);

  /***********************
   * LOAD / INIT
   ***********************/
  function loadSavedData(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw){
      // first run
      App.waTemplate = DEFAULT_WA_TEMPLATE;
      el.waTemplate.value = App.waTemplate;
      showUploadScreen();
      return;
    }
    try{
      const data = JSON.parse(raw);
      App.contacts = Array.isArray(data.contacts) ? data.contacts : [];
      App.origins = new Set(Array.isArray(data.origins) ? data.origins : []);
      App.operators = new Set(Array.isArray(data.operators) ? data.operators : DEFAULT_OPERATORS);
      App.waTemplate = data.waTemplate || DEFAULT_WA_TEMPLATE;

      rebuildIndexes();
      refreshFiltersUI();
      el.waTemplate.value = App.waTemplate;

      if (App.contacts.length){
        el.uploadScreen.style.display = 'none';
        el.mainInterface.style.display = 'block';
        render();
      } else {
        showUploadScreen();
      }
    }catch(e){
      console.error(e);
      localStorage.removeItem(STORAGE_KEY);
      App.waTemplate = DEFAULT_WA_TEMPLATE;
      el.waTemplate.value = App.waTemplate;
      showUploadScreen();
    }
  }

  loadSavedData();

})();
</script>

</body>
</html>
